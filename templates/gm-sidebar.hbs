<div class="gm-sidebar-container">
  <!-- NPCs Section -->
  <section class="npcs-section {{#if npcsPanelCollapsed}}collapsed{{/if}}" aria-labelledby="npcs-heading">
    <div class="section-header">
      <div class="section-header-left collapsible"
           data-action="toggleNPCsPanel"
           role="button"
           tabindex="0"
           aria-expanded="{{#unless npcsPanelCollapsed}}true{{else}}false{{/unless}}"
           aria-controls="npcs-panel-content">
        <h3 id="npcs-heading">NPCs</h3>
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
      </div>
      <div class="section-actions">
        <button type="button" data-action="addSpeakerFromImage" data-tooltip="Add NPC" aria-label="Add NPC from image">
          <i class="fas fa-plus" aria-hidden="true"></i>
        </button>
        {{#if hasSpeakers}}
        <button type="button" data-action="clearSpeaker" data-tooltip="Clear active NPC" aria-label="Deselect active NPC">
          <i class="fas fa-user-slash" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="clearAllSpeakers" data-tooltip="Clear all NPCs" aria-label="Remove all NPCs">
          <i class="fas fa-trash" aria-hidden="true"></i>
        </button>
        {{/if}}
      </div>
    </div>

    <div class="panel-content" id="npcs-panel-content">
      <div class="speaker-gallery" role="list" aria-label="NPC speakers">
      {{#if hasSpeakers}}
        {{#each speakers}}
          <div class="speaker-thumbnail {{#if (eq ../activeSpeaker this.id)}}active{{/if}} {{#if this.actorDeleted}}deleted{{/if}}"
               data-action="setSpeaker"
               data-speaker-id="{{this.id}}"
               data-tooltip="{{this.name}}{{#if this.actorDeleted}} (Actor Deleted){{/if}}"
               role="listitem"
               tabindex="0"
               aria-selected="{{#if (eq ../activeSpeaker this.id)}}true{{else}}false{{/if}}">
            <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
            <div class="speaker-name">{{this.name}}</div>
            <button type="button" class="remove-speaker" data-action="removeSpeaker" data-speaker-id="{{this.id}}" data-tooltip="Remove {{this.name}}" aria-label="Remove {{this.name}}">
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>
        {{/each}}
      {{else}}
        <div class="empty-state compact" role="status">
          <i class="fas fa-user-plus" aria-hidden="true"></i>
          <span>Drag actors here</span>
        </div>
      {{/if}}
      </div>

      {{#if hasJournalImages}}
      <div class="journal-images-inline">
        <div class="section-divider">
          <span>Journal Images</span>
        </div>
        <div class="journal-images-gallery">
        {{#each journalImages}}
          <div class="journal-image-item"
               data-action="setImageAsSpeaker"
               data-image-id="{{this.id}}"
               data-image-src="{{this.src}}"
               data-tooltip="Click to add {{this.alt}} as NPC">
            <div class="journal-image-item-thumb">
              <img src="{{this.src}}" alt="{{this.alt}}" loading="lazy">
            </div>
            <span class="journal-image-label">{{this.alt}}</span>
            <i class="fas fa-plus journal-image-add-icon"></i>
          </div>
        {{/each}}
        </div>
      </div>
      {{/if}}

      {{#if hasJournalActors}}
      <div class="journal-actors-inline">
        <div class="section-divider">
          <span>Journal Actors</span>
        </div>
        <div class="journal-actors-gallery">
        {{#each journalActors}}
          <div class="journal-actor-item"
               data-action="setActorAsSpeaker"
               data-actor-id="{{this.id}}"
               data-tooltip="Click to add {{this.name}} as NPC">
            <div class="journal-actor-item-thumb">
              <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
            </div>
            <span class="journal-actor-label">{{this.name}}</span>
            <i class="fas fa-plus journal-actor-add-icon"></i>
          </div>
        {{/each}}
        </div>
      </div>
      {{/if}}
    </div>
  </section>

  <!-- PCs Section -->
  <section class="pcs-section {{#if pcsPanelCollapsed}}collapsed{{/if}}" aria-labelledby="pcs-heading">
    <div class="section-header">
      <div class="section-header-left collapsible"
           data-action="togglePCsPanel"
           role="button"
           tabindex="0"
           aria-expanded="{{#unless pcsPanelCollapsed}}true{{else}}false{{/unless}}"
           aria-controls="pcs-panel-content">
        <h3 id="pcs-heading">PCs</h3>
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
      </div>
      <div class="section-actions">
        <button type="button" data-action="addPartyPCs" data-tooltip="Add party members" aria-label="Add all party members">
          <i class="fas fa-user-group" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="addAllPCs" data-tooltip="Add all PCs" aria-label="Add all player characters">
          <i class="fas fa-users" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="openPlayerWindows" data-tooltip="Open\Close on players" aria-label="Open StoryFrame viewer on all player clients">
          <i class="fas fa-tv" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="manageChallengeLibrary" data-tooltip="Challenge Library" aria-label="Manage saved challenges">
          <i class="fas fa-folder-open" aria-hidden="true"></i>
        </button>
        {{#if hasParticipants}}
        <button type="button" data-action="presentChallenge" data-tooltip="Present Challenge" aria-label="Present multi-option challenge to all players">
          <i class="fas fa-tasks" aria-hidden="true"></i>
        </button>
        {{/if}}
        {{#if hasParticipants}}
        <button type="button" data-action="clearAllParticipants" data-tooltip="Clear all PCs" aria-label="Remove all PCs">
          <i class="fas fa-trash" aria-hidden="true"></i>
        </button>
        {{/if}}
      </div>
    </div>

    <div class="panel-content" id="pcs-panel-content">
      <div class="participant-portraits" data-drop-zone="participant" role="list" aria-label="Player characters">
        {{#if hasParticipants}}
          {{#each participants}}
            <div class="participant-token {{#if this.selected}}selected{{/if}}"
                 data-action="toggleParticipantSelection"
                 data-participant-id="{{this.id}}"
                 data-tooltip="{{this.name}}"
                 role="listitem"
                 tabindex="0"
                 aria-selected="{{#if this.selected}}true{{else}}false{{/if}}">
              <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
              <button type="button" class="remove-btn"
                      data-action="removeParticipant"
                      data-participant-id="{{this.id}}"
                      data-tooltip="Remove"
                      aria-label="Remove {{this.name}}">
                <i class="fas fa-times" aria-hidden="true"></i>
              </button>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-state compact" role="status">
            <i class="fas fa-user-plus" aria-hidden="true"></i>
            <span>Use buttons above to add PCs</span>
          </div>
        {{/if}}
      </div>

      {{#if hasParticipants}}
      <div class="check-request-bar {{#if (and (gt selectedCount 0) currentDC)}}ready{{/if}}" role="toolbar" aria-label="Skill check controls">
        <div class="bar-top">
          <div class="selection-info {{#if (gt selectedCount 0)}}has-selection{{/if}}">
            <span class="count" aria-label="{{selectedCount}} of {{participants.length}} selected">{{selectedCount}}/{{participants.length}}</span>
            <button type="button" data-action="toggleSelectAll" class="link-btn" data-tooltip="{{#if allSelected}}Deselect all{{else}}Select all{{/if}}" aria-label="{{#if allSelected}}Deselect all{{else}}Select all{{/if}}">
              <i class="{{#if allSelected}}far fa-square{{else}}fas fa-check-double{{/if}}" aria-hidden="true"></i>
            </button>
          </div>

          <div class="dc-controls-wrapper">
            {{#if isPF2e}}
              {{#if partyLevel}}
              <div class="difficulty-selector compact">
                <span class="party-level" data-tooltip="Party Level">Lv{{partyLevel}}</span>
                <select id="difficulty-select" aria-label="Difficulty by level">
                  {{#each difficultyOptions}}
                    <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                  {{/each}}
                </select>
              </div>
              {{/if}}
            {{else if isDND5e}}
              <div class="difficulty-selector dnd5e compact">
                <select id="dc-select-dnd5e" data-action="setDCSelect" aria-label="Select difficulty">
                  {{#each dcOptions}}
                    <option value="{{this.dc}}" data-dc="{{this.dc}}" {{#if (eq this.dc ../currentDC)}}selected{{/if}}>{{this.label}}</option>
                  {{/each}}
                </select>
              </div>
            {{/if}}

            <div class="dc-input-group">
              <label class="dc-label" for="dc-input">DC</label>
              <input type="number"
                     id="dc-input"
                     class="dc-input"
                     value="{{currentDC}}"
                     min="1"
                     max="60"
                     placeholder="--"
                     aria-label="Difficulty class">
              <button type="button"
                      class="preset-btn"
                      data-action="togglePresetDropdown"
                      data-tooltip="DC Presets">
                <i class="fas fa-bookmark"></i>
              </button>
            </div>

            <label class="secret-roll-toggle" data-tooltip="GM Only Roll">
              <input type="checkbox" id="secret-roll-checkbox">
              <i class="fas fa-eye-slash"></i>
              <span>Secret</span>
            </label>

            <div class="preset-selector">
              <div class="preset-dropdown" style="display: none;">
                <div class="preset-add-form">
                  <input type="number"
                         id="new-preset-dc"
                         class="preset-dc-input"
                         placeholder="Add DC"
                         min="1"
                         max="60">
                  <button type="button"
                          class="preset-add-btn"
                          data-action="addPresetQuick"
                          data-tooltip="Add preset">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                {{#if dcPresets.length}}
                <div class="preset-divider"></div>
                <div class="preset-list">
                  {{#each dcPresets}}
                    <div class="preset-item">
                      <button type="button"
                              class="preset-option"
                              data-action="applyPreset"
                              data-preset-id="{{this.id}}"
                              data-dc="{{this.dc}}"
                              data-tooltip="{{this.name}}">
                        {{this.dc}}
                      </button>
                      <button type="button"
                              class="preset-delete-btn"
                              data-action="deletePresetQuick"
                              data-preset-id="{{this.id}}"
                              data-tooltip="Delete">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  {{/each}}
                </div>
                {{/if}}
              </div>
            </div>
          </div>
        </div>

        <div class="skill-actions" role="group" aria-label="Quick skill buttons">
          {{#each quickButtonSkills}}
            <button type="button"
                    class="skill-btn"
                    data-action="requestSkill"
                    data-skill="{{this.slug}}"
                    data-tooltip="{{this.name}}"
                    aria-label="Request {{this.name}} check">
              {{this.shortName}}
            </button>
          {{/each}}
          <button type="button" class="skill-btn more" data-action="openSkillMenu" data-tooltip="All Skills" aria-label="Show all skills menu">
            <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
          </button>
          <button type="button" class="skill-btn config" data-action="openSkillConfig" data-tooltip="Configure Quick Skills" aria-label="Configure quick skill buttons">
            <i class="fas fa-cog" aria-hidden="true"></i>
          </button>
        </div>

        {{#if hasLoreSkills}}
        <div class="lore-skills-section">
          <div class="lore-header">
            <i class="fas fa-book"></i>
            <span>Lore Skills</span>
          </div>
          <div class="lore-skills-grid">
            {{#each loreSkills}}
              <button type="button"
                      class="skill-btn lore"
                      data-action="requestSkill"
                      data-skill="{{this.slug}}"
                      data-tooltip="{{this.name}}"
                      aria-label="Request {{this.name}} check">
                {{this.name}}
              </button>
            {{/each}}
          </div>
        </div>
        {{/if}}

        {{#if hasJournalChecks}}
        <div class="journal-checks-inline">
          <div class="section-divider">
            <span>Journal Checks</span>
          </div>
          <div class="journal-checks-grid">
          {{#each journalCheckGroups}}
            <button type="button"
                    class="journal-skill-btn"
                    data-action="showCheckDCsPopup"
                    data-skill="{{this.skillName}}"
                    data-tooltip="{{this.skillName}} Checks"
                    aria-label="{{this.skillName}} Checks">
              {{this.skillName}}
            </button>
          {{/each}}
          </div>
        </div>
        {{/if}}
      </div>
      {{/if}}
    </div>
  </section>

  <!-- Pending Rolls Indicator -->
  {{#if pendingRolls.length}}
  <div class="pending-rolls-indicator" data-action="showPendingRolls" data-tooltip="{{pendingRolls.length}} pending roll(s) - click to manage" role="button" tabindex="0" aria-label="{{pendingRolls.length}} pending rolls, click to view">
    <i class="fas fa-hourglass-half" aria-hidden="true"></i>
    <span class="pending-count">{{pendingRolls.length}}</span>
  </div>
  {{/if}}

  <!-- Active Challenge Indicator -->
  {{#if hasActiveChallenge}}
  <div class="active-challenge-indicator" data-action="clearChallenge" data-tooltip="{{activeChallenge.name}} - click to clear" role="button" tabindex="0" aria-label="Active challenge: {{activeChallenge.name}}, click to clear">
    <i class="fas fa-tasks" aria-hidden="true"></i>
    <span class="challenge-name">{{activeChallenge.name}}</span>
  </div>
  {{/if}}
</div>
