<div class="gm-sidebar-container">
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button type="button"
            class="tab-btn {{#if (eq currentTab 'npcs')}}active{{/if}}"
            data-action="switchTab"
            data-tab="npcs">
      <i class="fas fa-masks-theater" aria-hidden="true"></i>
      <span>{{localize "STORYFRAME.UI.Tabs.NPCs"}}</span>
    </button>
    <button type="button"
            class="tab-btn {{#if (eq currentTab 'pcs')}}active{{/if}}"
            data-action="switchTab"
            data-tab="pcs">
      <i class="fas fa-users" aria-hidden="true"></i>
      <span>{{localize "STORYFRAME.UI.Tabs.PCs"}}</span>
      {{#if pendingRolls.length}}
      <span class="tab-badge" data-count="{{pendingRolls.length}}">{{pendingRolls.length}}</span>
      {{/if}}
    </button>
    <button type="button"
            class="tab-btn {{#if (eq currentTab 'challenges')}}active{{/if}}"
            data-action="switchTab"
            data-tab="challenges">
      <i class="fas fa-tasks" aria-hidden="true"></i>
      <span>{{localize "STORYFRAME.UI.Labels.Challenges"}}</span>
      {{#if hasActiveChallenge}}
      <span class="tab-badge active-badge">{{activeChallenges.length}}</span>
      {{/if}}
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- NPCs Tab -->
    <section class="npcs-tab {{#unless (eq currentTab 'npcs')}}hidden{{/unless}}" data-tab-content="npcs" aria-labelledby="npcs-heading">
      <div class="tab-scroll-content">
        <div class="tab-header-actions">
          <button type="button" data-action="addSpeakerFromImage" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.AddNPC"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.AddNPCFromImage"}}">
            <i class="fas fa-plus" aria-hidden="true"></i>
          </button>
          <button type="button" data-action="clearSpeaker" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ClearActiveNPC"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.DeselectActiveNPC"}}">
            <i class="fas fa-user-slash" aria-hidden="true"></i>
          </button>
          <button type="button" data-action="clearAllSpeakers" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ClearAllNPCs"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.RemoveAllNPCs"}}">
            <i class="fas fa-trash" aria-hidden="true"></i>
          </button>
          {{#if hasSpeakers}}
          <button type="button" data-action="saveCurrentSpeakers" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.SaveSpeakersAsScene"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.SaveSpeakersAsScene"}}">
            <i class="fas fa-save" aria-hidden="true"></i>
          </button>
          {{/if}}
          {{#if hasSpeakerScenes}}
          <button type="button" data-action="manageScenes" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ManageSpeakerScenes"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.ManageSpeakerScenes"}}">
            <i class="fas fa-folder" aria-hidden="true"></i>
          </button>
          {{/if}}
        </div>

        <div class="speaker-gallery" role="list" aria-label="{{localize "STORYFRAME.UI.AriaLabels.NPCSpeakers"}}">
        {{#if hasSpeakers}}
          {{#each speakers}}
            <div class="speaker-thumbnail {{#if (eq ../activeSpeaker this.id)}}active{{/if}} {{#if this.actorDeleted}}deleted{{/if}}"
                 data-action="setSpeaker"
                 data-speaker-id="{{this.id}}"
                 data-tooltip="{{this.name}}{{#if this.actorDeleted}} ({{localize "STORYFRAME.UI.Labels.ActorDeleted"}}){{/if}}"
                 role="listitem"
                 tabindex="0"
                 aria-selected="{{#if (eq ../activeSpeaker this.id)}}true{{else}}false{{/if}}">
              <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
              <div class="speaker-name">{{this.name}}</div>
              <button type="button" class="remove-speaker" data-action="removeSpeaker" data-speaker-id="{{this.id}}" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.RemoveName" name=this.name}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.RemoveName" name=this.name}}">
                <i class="fas fa-times" aria-hidden="true"></i>
              </button>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-state compact" role="status">
            <i class="fas fa-user-plus" aria-hidden="true"></i>
            <span>{{localize "STORYFRAME.UI.Labels.DragActorsHere"}}</span>
          </div>
        {{/if}}
        </div>

        {{#if hasJournalImages}}
        <div class="journal-images-inline">
          <div class="section-divider">
            <span>{{localize "STORYFRAME.UI.Labels.JournalImages"}}</span>
          </div>
          <div class="journal-images-gallery">
          {{#each journalImages}}
            <div class="journal-image-item"
                 data-action="setImageAsSpeaker"
                 data-image-id="{{this.id}}"
                 data-image-src="{{this.src}}"
                 data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ClickToAddAsNPC" name=this.alt}}">
              <div class="journal-image-item-thumb">
                <img src="{{this.src}}" alt="{{this.alt}}" loading="lazy">
              </div>
              <span class="journal-image-label">{{this.alt}}</span>
            </div>
          {{/each}}
          </div>
        </div>
        {{/if}}

        {{#if hasJournalActors}}
        <div class="journal-actors-inline">
          <div class="section-divider">
            <span>{{localize "STORYFRAME.UI.Labels.JournalActors"}}</span>
          </div>
          <div class="journal-actors-gallery">
          {{#each journalActors}}
            <div class="journal-actor-item"
                 data-action="setActorAsSpeaker"
                 data-actor-id="{{this.id}}"
                 data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ClickToAddAsNPC" name=this.name}}">
              <div class="journal-actor-item-thumb">
                <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
              </div>
              <span class="journal-actor-label">{{this.name}}</span>
            </div>
          {{/each}}
          </div>
        </div>
        {{/if}}
      </div>
    </section>

    <!-- PCs Tab -->
    <section class="pcs-tab {{#unless (eq currentTab 'pcs')}}hidden{{/unless}}" data-tab-content="pcs" aria-labelledby="pcs-heading">
      <div class="tab-header-actions">
        {{#if pendingRolls.length}}
        <button type="button" class="pending-rolls-btn" data-action="showPendingRolls" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.PendingRollsCount" count=pendingRolls.length}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.ViewPendingRolls"}}">
          <i class="fas fa-hourglass-half" aria-hidden="true"></i>
        </button>
        {{/if}}
        <button type="button" data-action="addPartyPCs" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.AddPartyMembers"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.AddPartyMembers"}}">
          <i class="fas fa-user-group" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="addAllPCs" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.AddAllPCs"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.AddAllPCs"}}">
          <i class="fas fa-users" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="openPlayerWindows" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.OpenCloseOnPlayers"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.OpenViewerOnPlayers"}}">
          <i class="fas fa-tv" aria-hidden="true"></i>
        </button>
        {{#if hasParticipants}}
        <button type="button" data-action="clearAllParticipants" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ClearAllPCs"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.RemoveAllPCs"}}">
          <i class="fas fa-trash" aria-hidden="true"></i>
        </button>
        {{/if}}
        <button type="button" class="" data-action="openSkillConfig" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ConfigureQuickSkills"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.ConfigureQuickSkills"}}">
          <i class="fas fa-cog" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="requestRollsFromSelection" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.RequestRollsFromSelection"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestRollsFromSelection"}}">
          <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i>
        </button>
      </div>

      {{#if hasParticipants}}
      <div class="dc-controls-bar" role="toolbar" aria-label="{{localize "STORYFRAME.UI.AriaLabels.DCControls"}}">
        <div class="participant-portraits participant-portraits-sticky" data-drop-zone="participant" role="list" aria-label="{{localize "STORYFRAME.UI.AriaLabels.PlayerCharacters"}}">
          {{#each participants}}
            <div class="participant-token {{#if this.selected}}selected{{/if}}"
                 data-action="toggleParticipantSelection"
                 data-participant-id="{{this.id}}"
                 data-tooltip="{{this.name}}"
                 role="listitem"
                 tabindex="0"
                 aria-selected="{{#if this.selected}}true{{else}}false{{/if}}">
              <img src="{{this.img}}" alt="{{this.name}}" loading="lazy">
              <button type="button" class="remove-btn"
                      data-action="removeParticipant"
                      data-participant-id="{{this.id}}"
                      data-tooltip="{{localize "STORYFRAME.UI.Labels.Remove"}}"
                      aria-label="{{localize "STORYFRAME.UI.AriaLabels.RemoveName" name=this.name}}">
                <i class="fas fa-times" aria-hidden="true"></i>
              </button>
            </div>
          {{/each}}
        </div>

        <div class="dc-controls-row">
          <button type="button" data-action="toggleSelectAll" class="select-all-btn" data-tooltip="{{#if allSelected}}{{localize "STORYFRAME.UI.Tooltips.DeselectAll"}}{{else}}{{localize "STORYFRAME.UI.Tooltips.SelectAll"}}{{/if}}" aria-label="{{#if allSelected}}{{localize "STORYFRAME.UI.Tooltips.DeselectAll"}}{{else}}{{localize "STORYFRAME.UI.Tooltips.SelectAll"}}{{/if}}">
            <i class="{{#if allSelected}}far fa-square{{else}}fas fa-check-double{{/if}}" aria-hidden="true"></i>
            <span>{{#if allSelected}}{{localize "STORYFRAME.UI.Labels.Deselect"}}{{else}}{{localize "STORYFRAME.UI.Labels.SelectAll"}}{{/if}}</span>
          </button>

          <div class="preset-selector">
            <div class="dc-input-group">
              <label class="dc-label" for="dc-input">{{localize "STORYFRAME.ChallengeBuilder.DC"}}</label>
              <input type="number"
                     id="dc-input"
                     class="dc-input"
                     value="{{currentDC}}"
                     min="1"
                     placeholder="--"
                     aria-label="{{localize "STORYFRAME.UI.AriaLabels.DifficultyClass"}}">
              <button type="button"
                      class="preset-btn"
                      data-action="togglePresetDropdown"
                      data-tooltip="{{localize "STORYFRAME.UI.Tooltips.DCPresets"}}">
                <i class="fas fa-bookmark"></i>
              </button>
              <button type="button"
                      class="secret-roll-btn {{#if secretRollEnabled}}active{{/if}}"
                      data-action="toggleSecretRoll"
                      data-tooltip="{{localize "STORYFRAME.UI.Tooltips.GMOnlyRoll"}}"
                      aria-label="{{localize "STORYFRAME.UI.AriaLabels.ToggleSecretRoll"}}"
                      aria-pressed="{{#if secretRollEnabled}}true{{else}}false{{/if}}">
                <i class="fas fa-eye-slash" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <button type="button"
                  class="send-batch-btn"
                  data-action="sendBatch"
                  data-tooltip="{{localize "STORYFRAME.UI.Tooltips.SendBatchedSkillChecks"}}"
                  aria-label="{{localize "STORYFRAME.UI.AriaLabels.SendBatch"}}"
                  style="display: none;">
            <i class="fas fa-paper-plane" aria-hidden="true"></i>
            <span class="batch-count">0</span>
          </button>

          <label class="allow-only-one-toggle" style="display: none;">
            <input type="checkbox"
                   id="allow-only-one-toggle"
                   data-action="toggleAllowOnlyOne"
                   {{#if allowOnlyOneEnabled}}checked{{/if}}>
            <span>{{localize "STORYFRAME.UI.Labels.AllowOnlyOne"}}</span>
            <i class="fas fa-info-circle"
               data-tooltip="{{localize "STORYFRAME.UI.Tooltips.AllowOnlyOne"}}"
               aria-hidden="true"></i>
          </label>
        </div>
      </div>
      {{/if}}

      <div class="tab-scroll-content">
        {{#if hasParticipants}}
        {{#if hasJournalChecks}}
        <div class="journal-checks-inline">
          <div class="section-divider">
            <span>{{localize "STORYFRAME.UI.Labels.JournalSkills"}}</span>
          </div>
          <div class="journal-checks-grid">
          {{#each journalSkillGroups}}
            <div class="journal-check-wrapper">
              <button type="button"
                      class="journal-skill-btn"
                      data-action="showCheckDCsPopup"
                      data-skill="{{this.skillName}}"
                      data-check-type="skill"
                      data-tooltip="{{localize "STORYFRAME.UI.Tooltips.SkillChecks" skill=this.skillName}}"
                      aria-label="{{localize "STORYFRAME.UI.AriaLabels.SkillChecks" skill=this.skillName}}">
                {{this.skillName}}
              </button>
            </div>
          {{/each}}
          </div>
        </div>
        {{/if}}

        {{#if hasJournalSaves}}
        <div class="journal-saves-inline">
          <div class="section-divider">
            <span>{{localize "STORYFRAME.UI.Labels.JournalSaves"}}</span>
          </div>
          <div class="journal-saves-grid">
          {{#each journalSaveGroups}}
            <div class="journal-save-wrapper">
              <button type="button"
                      class="journal-save-btn"
                      data-action="showCheckDCsPopup"
                      data-skill="{{this.skillName}}"
                      data-check-type="save"
                      data-tooltip="{{localize "STORYFRAME.UI.Tooltips.SavingThrows" save=this.skillName}}"
                      aria-label="{{localize "STORYFRAME.UI.AriaLabels.SavingThrows" save=this.skillName}}">
                {{this.skillName}}
              </button>
            </div>
          {{/each}}
          </div>
        </div>
        {{/if}}

        {{#if hasLoreSkills}}
        <div class="lore-skills-section">
          <div class="lore-header">
            <span>{{localize "STORYFRAME.ChallengeBuilder.LoreSkills"}}</span>
          </div>
          <div class="lore-skills-grid">
            {{#each loreSkills}}
              <div class="lore-skill-wrapper">
                <button type="button"
                        class="skill-btn lore"
                        data-action="requestSkill"
                        data-skill="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSkillCheck" skill=this.name}}">
                  {{this.name}}
                </button>
              </div>
            {{/each}}
          </div>
        </div>
        {{/if}}

        <div class="skill-categories" role="group" aria-label="{{localize "STORYFRAME.UI.AriaLabels.SkillButtonsByCategory"}}">
          {{#if physicalSkills.length}}
          <div class="skill-category">
            <span class="category-label">{{localize "STORYFRAME.UI.Categories.Physical"}}</span>
            <div class="category-skills">
              {{#each physicalSkills}}
              <div class="skill-btn-wrapper">
                <button type="button"
                        class="skill-btn"
                        data-action="requestSkill"
                        data-skill="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSkillCheck" skill=this.name}}">
                  <i class="fas {{this.icon}}" aria-hidden="true"></i>
                </button>
                <span class="skill-label">{{this.name}}</span>
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{#if magicalSkills.length}}
          <div class="skill-category">
            <span class="category-label">{{localize "STORYFRAME.UI.Categories.Magical"}}</span>
            <div class="category-skills">
              {{#each magicalSkills}}
              <div class="skill-btn-wrapper">
                <button type="button"
                        class="skill-btn"
                        data-action="requestSkill"
                        data-skill="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSkillCheck" skill=this.name}}">
                  <i class="fas {{this.icon}}" aria-hidden="true"></i>
                </button>
                <span class="skill-label">{{this.name}}</span>
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{#if socialSkills.length}}
          <div class="skill-category">
            <span class="category-label">{{localize "STORYFRAME.UI.Categories.Social"}}</span>
            <div class="category-skills">
              {{#each socialSkills}}
              <div class="skill-btn-wrapper">
                <button type="button"
                        class="skill-btn"
                        data-action="requestSkill"
                        data-skill="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSkillCheck" skill=this.name}}">
                  <i class="fas {{this.icon}}" aria-hidden="true"></i>
                </button>
                <span class="skill-label">{{this.name}}</span>
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{#if utilitySkills.length}}
          <div class="skill-category">
            <span class="category-label">{{localize "STORYFRAME.UI.Categories.Utility"}}</span>
            <div class="category-skills">
              {{#each utilitySkills}}
              <div class="skill-btn-wrapper">
                <button type="button"
                        class="skill-btn"
                        data-action="requestSkill"
                        data-skill="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSkillCheck" skill=this.name}}">
                  <i class="fas {{this.icon}}" aria-hidden="true"></i>
                </button>
                <span class="skill-label">{{this.name}}</span>
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{#if saves.length}}
          <div class="skill-category saves-category">
            <span class="category-label">{{localize "STORYFRAME.UI.Categories.SavingThrows"}}</span>
            <div class="category-skills">
              {{#each saves}}
              <div class="skill-btn-wrapper save-btn-wrapper">
                <button type="button"
                        class="skill-btn save-btn"
                        data-action="requestSave"
                        data-save="{{this.slug}}"
                        data-tooltip="{{this.name}}"
                        aria-label="{{localize "STORYFRAME.UI.AriaLabels.RequestSave" save=this.name}}">
                  <i class="fas {{this.icon}}" aria-hidden="true"></i>
                </button>
                <span class="skill-label">{{this.name}}</span>
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}
        </div>
        {{/if}}
      </div>
    </section>

    <!-- Challenges Tab -->
    <section class="challenges-tab {{#unless (eq currentTab 'challenges')}}hidden{{/unless}}" data-tab-content="challenges" aria-labelledby="challenges-heading">
      <div class="tab-header-actions">
        {{#if hasActiveChallenge}}
        <button type="button" class="active-challenges-btn" data-action="showActiveChallenges" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.ActiveChallengesCount" count=activeChallenges.length}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.ViewActiveChallenges"}}">
          <i class="fas fa-flag-checkered" aria-hidden="true"></i>
        </button>
        {{/if}}
        <button type="button" data-action="presentChallenge" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.PresentChallenge"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.PresentChallenge"}}">
          <i class="fas fa-tasks" aria-hidden="true"></i>
        </button>
        <button type="button" data-action="createChallengeFromSelection" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.CreateFromSelection"}}" aria-label="{{localize "STORYFRAME.UI.AriaLabels.CreateFromSelection"}}">
          <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i>
        </button>
      </div>
      <div class="tab-scroll-content">
        {{#if hasSavedChallenges}}
          {{#each savedChallenges}}
          <div class="lib-challenge-card {{#if this.collapsed}}collapsed{{/if}}" data-challenge-id="{{this.id}}">
            <div class="lib-card-header"
                 data-action="toggleLibraryChallengeCollapse"
                 role="button"
                 tabindex="0"
                 aria-expanded="{{#unless this.collapsed}}true{{else}}false{{/unless}}">
              <i class="fas fa-chevron-{{#if this.collapsed}}right{{else}}down{{/if}} collapse-icon" aria-hidden="true"></i>
              <div class="lib-card-title-section">
                <i class="fas fa-flag-checkered lib-card-icon"></i>
                <span class="lib-card-title">{{this.name}}</span>
              </div>
              <div class="lib-card-actions">
                <button type="button" class="lib-edit-btn" data-action="editChallenge" data-challenge-id="{{this.id}}" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.EditChallenge"}}">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="lib-delete-btn" data-action="deleteChallenge" data-challenge-id="{{this.id}}" data-tooltip="{{localize "STORYFRAME.UI.Tooltips.DeleteChallenge"}}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            {{#unless this.collapsed}}
            <div class="lib-card-body">
              {{#each this.options}}
              <div class="lib-option-preview">
                <div class="opt-num">{{localize "STORYFRAME.ChallengeBuilder.OptionLabel" num=this.index}}</div>
                <div class="opt-desc">{{this.name}}</div>
                <div class="opt-skills">
                  {{#each this.skillOptions}}
                  <span class="skill-dc-pill" data-check-type="{{this.checkType}}">
                    {{this.displayText}}{{#if this.dc}} <strong>{{localize "STORYFRAME.ChallengeBuilder.DC"}} {{this.dc}}</strong>{{/if}}
                    {{#if this.isSecret}}<i class="fas fa-eye-slash secret-marker"></i>{{/if}}
                  </span>
                  {{/each}}
                </div>
              </div>
              {{/each}}
            </div>

            <button type="button"
                    class="lib-present-btn"
                    data-action="presentSavedChallenge"
                    data-challenge-id="{{this.id}}">
              <i class="fas fa-paper-plane"></i> {{localize "STORYFRAME.UI.Labels.PresentToAllPlayers"}}
            </button>
            {{/unless}}
          </div>
          {{/each}}
        {{else}}
          <div class="lib-empty-state">
            <i class="fas fa-folder-open"></i>
            <p>{{localize "STORYFRAME.UI.Labels.NoSavedChallenges"}}</p>
            <p class="hint">{{localize "STORYFRAME.UI.Labels.CreateChallengeHint"}}</p>
          </div>
        {{/if}}
      </div>
    </section>
  </div>
</div>
