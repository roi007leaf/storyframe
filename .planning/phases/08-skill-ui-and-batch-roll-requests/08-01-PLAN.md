---
phase: 08-skill-ui-batch-rolls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - styles/gm-sidebar.css
  - templates/gm-sidebar.hbs
autonomous: true

must_haves:
  truths:
    - "Empty skill category headers are hidden (no layout space occupied)"
    - "Skills grouped correctly: Stealth/Thievery in Physical, Mental renamed to Magical, Perception in Utility"
    - "Display order preserved: Journal Checks -> Lore Skills -> Quick Skill Buttons"
    - "Grid density targets 4 skills per row at standard width"
  artifacts:
    - path: "styles/gm-sidebar.css"
      provides: "CSS Grid auto-fill layout with responsive skill buttons"
      contains: "repeat(auto-fill, minmax(70px, 1fr))"
    - path: "templates/gm-sidebar.hbs"
      provides: "Skill grid template with category groupings"
      contains: "skill-category"
  key_links:
    - from: "templates/gm-sidebar.hbs"
      to: "styles/gm-sidebar.css"
      via: "skill-category, skill-grid CSS classes"
      pattern: "skill-category|skill-grid"
---

<objective>
Refactor skill UI to use responsive CSS Grid layout with intelligent skill groupings and empty category hiding.

Purpose: Create a polished, dense skill interface that adapts to sidebar width and hides empty sections to reduce visual clutter during live play.

Output: Updated CSS with auto-fill grid layout and template restructured with skill categories (Physical, Magical, Social, Utility).
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-CONTEXT.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-RESEARCH.md
@styles/gm-sidebar.css
@templates/gm-sidebar.hbs
@scripts/system-adapter.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSS Grid Auto-Fill Layout with Category Hiding</name>
  <files>styles/gm-sidebar.css</files>
  <action>
Update the skill button grid CSS in gm-sidebar.css:

1. Change `.skill-actions` grid from `minmax(42px, 1fr)` to `minmax(70px, 1fr)` to target ~4 skills per row at standard 330px sidebar width.

2. Add new `.skill-grid` class for category-based skill grids:
```css
.skill-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  gap: 8px;
  margin-bottom: 8px;
}
```

3. Add `.skill-category` styles for grouped sections:
```css
.skill-category {
  margin-bottom: 12px;
}

.skill-category-header {
  font-size: var(--sf-font-xs);
  font-weight: 600;
  color: var(--sf-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--sf-border-subtle);
}
```

4. Add CSS :has() selector to hide empty categories completely:
```css
.skill-category:not(:has(.skill-btn)) {
  display: none;
}

/* Fallback: also hide if .skill-grid is empty */
.skill-category:has(.skill-grid:empty) {
  display: none;
}
```

5. Keep existing `.skill-btn` styles but ensure min-width: 70px for consistent sizing.

6. Update `.lore-skills-grid` to match new grid pattern: `minmax(70px, 1fr)`.

7. Preserve existing `.skill-btn.lore` styling (amber/gold color scheme).
  </action>
  <verify>
Review CSS file: Grid uses auto-fill with minmax(70px, 1fr). Empty category hiding uses :has() selector. No horizontal overflow on narrow sidebars.
  </verify>
  <done>
CSS Grid layout with auto-fill minmax(70px, 1fr) implemented. Empty categories hidden via :has() selector. Skill buttons maintain 70px minimum width.
  </done>
</task>

<task type="auto">
  <name>Task 2: Template Restructure with Skill Categories</name>
  <files>templates/gm-sidebar.hbs</files>
  <action>
Restructure the skill section in gm-sidebar.hbs to use category-based groupings:

1. Replace the existing flat `.skill-actions` grid with categorized sections. Order MUST be:
   - Journal Checks (if hasJournalChecks) - already exists, move to TOP
   - Lore Skills (if hasLoreSkills) - already exists
   - Quick Skill Buttons - restructure into categories

2. For Quick Skill Buttons, group by category from system-adapter.mjs:
   - Physical: acr, ath, ste, thi (Stealth/Thievery moved from old Mental)
   - Magical: arc, nat, occ, rel (renamed from Mental)
   - Social: dec, dip, itm, prf
   - Utility: med, sur, cra, soc, per (Perception added here)

3. Template structure for each category:
```handlebars
{{#if physicalSkills.length}}
<div class="skill-category physical">
  <div class="skill-category-header">Physical</div>
  <div class="skill-grid">
    {{#each physicalSkills}}
      <button type="button"
              class="skill-btn"
              data-action="requestSkill"
              data-skill="{{this.slug}}"
              data-tooltip="{{this.name}}"
              aria-label="Request {{this.name}} check">
        {{this.shortName}}
      </button>
    {{/each}}
  </div>
</div>
{{/if}}
```

4. Repeat for Magical, Social, Utility categories.

5. Keep the "more" and "config" buttons at the end of the skill section (outside categories).

6. Update context: The `_prepareContext()` method in gm-sidebar.mjs will need to be updated to provide `physicalSkills`, `magicalSkills`, `socialSkills`, `utilitySkills` arrays. For now, the template can reference these even if undefined (will render nothing until Plan 02 updates context).

7. Preserve existing Journal Checks and Lore Skills sections but ensure they appear BEFORE the category grids.

Note: The Handlebars template should handle undefined arrays gracefully - {{#if undefined}} is falsy. This allows incremental implementation.
  </action>
  <verify>
Review template: Categories appear in correct order (Journal Checks -> Lore -> Physical -> Magical -> Social -> Utility). Each category uses .skill-category wrapper with .skill-grid inside.
  </verify>
  <done>
Template restructured with skill categories. Display order is Journal Checks -> Lore Skills -> Quick Skills (Physical/Magical/Social/Utility). Empty categories will hide automatically via CSS.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Context Preparation with Category Arrays</name>
  <files>scripts/applications/gm-sidebar.mjs</files>
  <action>
Update `_prepareContext()` in GMSidebarAppBase to provide skill category arrays:

1. Find the section that builds `quickButtonSkills` (around line 400-450 based on code analysis).

2. Add category grouping logic after getting systemSkills:
```javascript
// Group skills by category for template
const skillCategories = {
  physical: ['acr', 'ath', 'ste', 'thi'],
  magical: ['arc', 'nat', 'occ', 'rel'],
  social: ['dec', 'dip', 'itm', 'prf'],
  utility: ['med', 'sur', 'cra', 'soc', 'per']
};

const physicalSkills = [];
const magicalSkills = [];
const socialSkills = [];
const utilitySkills = [];

for (const [slug, skill] of Object.entries(systemSkills)) {
  const skillData = {
    slug,
    name: skill.name,
    shortName: skill.shortName || slug.toUpperCase()
  };

  if (skillCategories.physical.includes(slug)) {
    physicalSkills.push(skillData);
  } else if (skillCategories.magical.includes(slug)) {
    magicalSkills.push(skillData);
  } else if (skillCategories.social.includes(slug)) {
    socialSkills.push(skillData);
  } else if (skillCategories.utility.includes(slug)) {
    utilitySkills.push(skillData);
  }
}
```

3. Add these arrays to the returned context object:
```javascript
return {
  ...existingContext,
  physicalSkills,
  magicalSkills,
  socialSkills,
  utilitySkills,
  // Keep quickButtonSkills for backward compatibility if needed
};
```

4. Preserve the existing `quickButtonSkills` calculation as fallback until template is fully updated.

5. Note: The skill categories are intentionally hardcoded in the base class. System-specific subclasses (PF2e, DnD5e) can override if needed, but the standard PF2e skills map correctly to these categories.
  </action>
  <verify>
In browser console while GM sidebar is open: Check that context includes physicalSkills, magicalSkills, socialSkills, utilitySkills arrays with correct skill slugs per category.
  </verify>
  <done>
Context preparation provides skill category arrays. Physical includes ste/thi, Magical renamed from Mental, Utility includes per. Categories render correctly in template.
  </done>
</task>

</tasks>

<verification>
1. Open FoundryVTT with StoryFrame module enabled
2. Open a journal and verify GM sidebar appears
3. Check skill grid layout: buttons should be ~70px wide, approximately 4 per row
4. Verify category headers appear: Physical, Magical, Social, Utility
5. Verify display order: Journal Checks -> Lore Skills -> Quick Skills (categorized)
6. With no PCs selected, verify empty Lore Skills section is hidden (no header, no space)
7. Resize sidebar or window: verify grid reflows responsively without overflow
</verification>

<success_criteria>
- CSS Grid uses `repeat(auto-fill, minmax(70px, 1fr))`
- Empty categories hidden via `:has()` selector
- Skills grouped: Stealth/Thievery in Physical, Mental renamed to Magical, Perception in Utility
- Display order: Journal Checks -> Lore Skills -> Quick Skills (by category)
- No horizontal scrolling or button overflow
</success_criteria>

<output>
After completion, create `.planning/phases/08-skill-ui-and-batch-roll-requests/08-01-SUMMARY.md`
</output>
