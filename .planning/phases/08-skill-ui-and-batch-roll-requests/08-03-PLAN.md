---
phase: 08-skill-ui-batch-rolls
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/applications/gm-sidebar.mjs
  - scripts/applications/challenge-builder.mjs
  - templates/gm-sidebar.hbs
  - styles/gm-sidebar.css
autonomous: true

must_haves:
  truths:
    - "Only one active challenge per unique name (duplicates blocked with error message)"
    - "Multiple different named challenges can be active simultaneously"
    - "Challenge headers are collapsible/expandable independently"
  artifacts:
    - path: "scripts/applications/challenge-builder.mjs"
      provides: "Challenge uniqueness validation"
      contains: "already exists"
    - path: "templates/gm-sidebar.hbs"
      provides: "Collapsible challenge headers"
      contains: "challenge-header"
  key_links:
    - from: "challenge-builder.mjs"
      to: "state-manager.mjs"
      via: "setActiveChallenge validation"
      pattern: "setActiveChallenge"
---

<objective>
Add challenge uniqueness validation and collapsible challenge headers for better challenge management.

Purpose: Prevent duplicate challenge names that confuse players about which challenge they're responding to, and allow GMs to collapse challenges to reduce UI clutter when managing multiple concurrent challenges.

Output: Validation that blocks duplicate challenge names with error message, and independently collapsible challenge header UI.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-CONTEXT.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-RESEARCH.md
@scripts/applications/challenge-builder.mjs
@scripts/applications/gm-sidebar.mjs
@scripts/state-manager.mjs
@templates/gm-sidebar.hbs
@styles/gm-sidebar.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Challenge Uniqueness Validation</name>
  <files>scripts/applications/challenge-builder.mjs</files>
  <action>
Add validation to prevent duplicate challenge names in ChallengeBuilderDialog:

1. Find the submit/save handler in challenge-builder.mjs that calls `setActiveChallenge`.

2. Before calling `setActiveChallenge`, add validation:
```javascript
// Validate challenge name uniqueness
const challengeName = formData.get('challengeName')?.trim() || formData.challengeName?.trim();

if (!challengeName) {
  ui.notifications.error('Challenge name is required');
  return;
}

// Check for existing challenge with same name
const state = game.storyframe.stateManager.getState();
if (state?.activeChallenge?.name === challengeName) {
  ui.notifications.error(`Challenge "${challengeName}" already exists`);
  return;
}

// Also check activeChallenges array if it exists (for future multi-challenge support)
if (state?.activeChallenges?.some(c => c.name === challengeName)) {
  ui.notifications.error(`Challenge "${challengeName}" already exists`);
  return;
}
```

3. This validation should run BEFORE any call to setActiveChallenge or addActiveChallenge.

4. The error message format must be exactly: `Challenge "{name}" already exists` (as specified in CONTEXT.md).

5. Note: Currently the state only supports a single activeChallenge. The validation checks both patterns (single and array) to be forward-compatible with multi-challenge support if added later.
  </action>
  <verify>
In FoundryVTT: Create a challenge named "Test Challenge". Try to create another challenge with the same name. Verify error notification appears: `Challenge "Test Challenge" already exists`.
  </verify>
  <done>
Challenge uniqueness validation blocks duplicate names with error message. Validation runs before setActiveChallenge is called.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Collapsible Challenge Headers</name>
  <files>scripts/applications/gm-sidebar.mjs, templates/gm-sidebar.hbs, styles/gm-sidebar.css</files>
  <action>
Add collapsible/expandable challenge header UI:

1. In GMSidebarAppBase constructor, add challenge collapse state:
```javascript
// Challenge collapse state (Map: challengeId -> boolean)
this.collapsedChallenges = new Map();
```

2. Add action handler in DEFAULT_OPTIONS.actions:
```javascript
toggleChallengeCollapse: GMSidebarAppBase._onToggleChallengeCollapse,
```

3. Add static handler:
```javascript
static _onToggleChallengeCollapse(_event, target) {
  const challengeId = target.closest('[data-challenge-id]')?.dataset.challengeId;
  if (!challengeId) return;

  const isCollapsed = this.collapsedChallenges.get(challengeId) || false;
  this.collapsedChallenges.set(challengeId, !isCollapsed);
  this.render();
}
```

4. In _prepareContext, add collapse state to challenge data:
```javascript
// Add collapse state to active challenge
if (state?.activeChallenge) {
  const challengeWithState = {
    ...state.activeChallenge,
    collapsed: this.collapsedChallenges.get(state.activeChallenge.id) || false
  };
  context.activeChallenge = challengeWithState;
}
```

5. Update templates/gm-sidebar.hbs challenge section. Replace the current Active Challenge Indicator with a proper challenge display:

Find the `{{#if hasActiveChallenge}}` section and update:
```handlebars
{{#if hasActiveChallenge}}
<div class="active-challenge-card {{#if activeChallenge.collapsed}}collapsed{{/if}}"
     data-challenge-id="{{activeChallenge.id}}">
  <div class="challenge-header"
       data-action="toggleChallengeCollapse"
       role="button"
       tabindex="0"
       aria-expanded="{{#unless activeChallenge.collapsed}}true{{else}}false{{/unless}}">
    <div class="challenge-header-left">
      <i class="fas fa-chevron-{{#if activeChallenge.collapsed}}down{{else}}up{{/if}} collapse-icon" aria-hidden="true"></i>
      <span class="challenge-name">{{activeChallenge.name}}</span>
    </div>
    <div class="challenge-status">
      {{#if activeChallenge.collapsed}}
        <span class="status-summary">Challenge active</span>
      {{/if}}
    </div>
    <button type="button"
            class="challenge-clear-btn"
            data-action="clearChallenge"
            data-tooltip="Clear Challenge"
            aria-label="Clear {{activeChallenge.name}}">
      <i class="fas fa-times" aria-hidden="true"></i>
    </button>
  </div>

  {{#unless activeChallenge.collapsed}}
  <div class="challenge-content">
    {{#if activeChallenge.image}}
    <div class="challenge-image">
      <img src="{{activeChallenge.image}}" alt="{{activeChallenge.name}}">
    </div>
    {{/if}}
    <div class="challenge-options">
      {{#each activeChallenge.options}}
        <div class="challenge-option">
          <span class="option-name">{{this.name}}</span>
          {{#if this.skill}}
            <span class="option-skill">{{this.skill}}</span>
          {{/if}}
        </div>
      {{/each}}
    </div>
  </div>
  {{/unless}}
</div>
{{/if}}
```

6. Add CSS for collapsible challenge in styles/gm-sidebar.css:
```css
/* Active Challenge Card */
.active-challenge-card {
  background: var(--sf-bg-elevated);
  border: 1px solid var(--sf-border-medium);
  border-radius: var(--sf-radius-md);
  overflow: hidden;
  margin-top: var(--sf-space-sm);
}

.active-challenge-card .challenge-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  cursor: pointer;
  background: var(--sf-bg-hover);
  transition: background var(--sf-transition-fast);
}

.active-challenge-card .challenge-header:hover {
  background: rgba(255, 255, 255, 0.08);
}

.active-challenge-card .challenge-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.active-challenge-card .collapse-icon {
  font-size: var(--sf-font-xs);
  color: var(--sf-text-muted);
  transition: transform var(--sf-transition-base);
}

.active-challenge-card .challenge-name {
  font-weight: 600;
  font-size: var(--sf-font-sm);
  color: var(--color-text-light-primary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.active-challenge-card .challenge-status {
  display: flex;
  align-items: center;
  gap: 8px;
}

.active-challenge-card .status-summary {
  font-size: var(--sf-font-xs);
  color: var(--sf-text-muted);
  font-style: italic;
}

.active-challenge-card .challenge-clear-btn {
  background: transparent;
  border: none;
  color: var(--sf-text-muted);
  cursor: pointer;
  padding: 4px 6px;
  border-radius: var(--sf-radius-sm);
  transition: all var(--sf-transition-fast);
}

.active-challenge-card .challenge-clear-btn:hover {
  color: var(--sf-danger);
  background: rgba(var(--sf-danger-rgb), 0.1);
}

.active-challenge-card .challenge-content {
  padding: 12px;
  border-top: 1px solid var(--sf-border-subtle);
}

.active-challenge-card.collapsed .challenge-content {
  display: none;
}

.active-challenge-card .challenge-image {
  margin-bottom: 10px;
}

.active-challenge-card .challenge-image img {
  width: 100%;
  border-radius: var(--sf-radius-sm);
}

.active-challenge-card .challenge-options {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.active-challenge-card .challenge-option {
  display: flex;
  justify-content: space-between;
  padding: 6px 10px;
  background: var(--sf-bg-elevated);
  border-radius: var(--sf-radius-sm);
  font-size: var(--sf-font-xs);
}

.active-challenge-card .option-skill {
  color: var(--sf-accent-primary);
  font-weight: 500;
}
```

7. Remove or update the old `.active-challenge-indicator` styles since we're replacing that UI element with the new card format.
  </action>
  <verify>
In FoundryVTT: Present a challenge. Verify challenge card appears with collapsible header. Click header to collapse - verify content hides and "Challenge active" summary appears. Click again to expand.
  </verify>
  <done>
Challenge headers are collapsible/expandable by clicking anywhere on header. Collapsed state shows "Challenge active" summary. Clear button accessible in both states.
  </done>
</task>

</tasks>

<verification>
1. Open FoundryVTT with StoryFrame module
2. Create a challenge via Challenge Builder with name "Test Challenge"
3. Verify challenge appears in sidebar with collapsible header
4. Click anywhere on challenge header - verify it collapses
5. Verify collapsed state shows "Challenge active" status summary
6. Click header again - verify it expands
7. Try to create another challenge with name "Test Challenge"
8. Verify error notification: `Challenge "Test Challenge" already exists`
9. Create challenge with different name - verify it works
10. Clear challenge and verify it's removed
</verification>

<success_criteria>
- Duplicate challenge names blocked with error message
- Challenge header collapses/expands on click
- Collapsed state shows status summary
- Clear button works in both collapsed and expanded states
- Collapse state persists during re-renders (within session)
</success_criteria>

<output>
After completion, create `.planning/phases/08-skill-ui-and-batch-roll-requests/08-03-SUMMARY.md`
</output>
