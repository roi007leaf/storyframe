---
phase: 08-skill-ui-batch-rolls
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/applications/gm-sidebar.mjs
  - scripts/applications/gm-sidebar-pf2e.mjs
autonomous: true

must_haves:
  truths:
    - "Multi-PC selection aggregates all lore skills from selected PCs"
    - "Shift+click toggles skill selection (add/remove from selection set)"
    - "Skill selection is blocked if no participants are chosen"
    - "Skill selection clears when participants change"
  artifacts:
    - path: "scripts/applications/gm-sidebar.mjs"
      provides: "Multi-skill selection state management"
      contains: "selectedSkills"
    - path: "scripts/applications/gm-sidebar-pf2e.mjs"
      provides: "Aggregated lore skills across multiple PCs"
      contains: "_getLoreSkills"
  key_links:
    - from: "gm-sidebar.mjs"
      to: "gm-sidebar-pf2e.mjs"
      via: "_getLoreSkills static method call"
      pattern: "_getLoreSkills\\(state, this\\.selectedParticipants\\)"
---

<objective>
Add multi-skill selection state tracking and update lore skill aggregation to support multiple selected PCs.

Purpose: Enable GM to select multiple skills for batch roll requests by tracking selection state, and ensure all selected PCs contribute their lore skills to the available pool.

Output: Multi-skill selection with Set-based tracking, updated lore skill aggregation for multi-PC, and selection clearing on participant changes.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-CONTEXT.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-RESEARCH.md
@scripts/applications/gm-sidebar.mjs
@scripts/applications/gm-sidebar-pf2e.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Multi-Skill Selection State to GMSidebarAppBase</name>
  <files>scripts/applications/gm-sidebar.mjs</files>
  <action>
Add multi-skill selection state management to GMSidebarAppBase:

1. In constructor (around line 91), add new state properties:
```javascript
// Multi-skill selection state
this.selectedSkills = new Set();
this.lastSelectedSkill = null;
```

2. Add a method to handle skill selection with shift-click:
```javascript
/**
 * Toggle skill selection
 * @param {string} skillSlug - The skill slug to toggle
 * @param {boolean} isShiftClick - Whether shift was held
 */
_toggleSkillSelection(skillSlug, isShiftClick) {
  // Block if no participants selected
  if (this.selectedParticipants.size === 0) {
    ui.notifications.warn('Select participants first');
    return;
  }

  if (isShiftClick) {
    // Toggle: add if not present, remove if present
    if (this.selectedSkills.has(skillSlug)) {
      this.selectedSkills.delete(skillSlug);
    } else {
      this.selectedSkills.add(skillSlug);
    }
  } else {
    // Regular click: immediate request (existing behavior)
    // Don't modify selection on regular click
    return false; // Signal to proceed with normal request
  }

  this.lastSelectedSkill = skillSlug;
  this.render();
  return true; // Signal that selection was handled
}

/**
 * Clear all skill selections
 */
_clearSkillSelection() {
  this.selectedSkills.clear();
  this.lastSelectedSkill = null;
  // Don't auto-render - caller should decide
}
```

3. Add action handler for clearing skill selection. In DEFAULT_OPTIONS.actions, add:
```javascript
clearSkillSelection: GMSidebarAppBase._onClearSkillSelection,
```

4. Add the static handler:
```javascript
static _onClearSkillSelection() {
  this._clearSkillSelection();
  this.render();
}
```

5. Modify `_onToggleParticipantSelection` to clear skill selection when participants change:
Find the existing `_onToggleParticipantSelection` handler and add at the end (before render):
```javascript
// Clear skill selection when participants change
if (this.selectedSkills?.size > 0) {
  this._clearSkillSelection();
  ui.notifications.info('Skill selection cleared');
}
```

6. Also add the same clearing logic to `_onClearAllParticipants` and `_onRemoveParticipant`.

7. In `_prepareContext()`, add selectedSkills data for template:
```javascript
// Convert Set to Array for template
const selectedSkillsArray = Array.from(this.selectedSkills || []);

return {
  ...context,
  selectedSkills: selectedSkillsArray,
  hasSelectedSkills: selectedSkillsArray.length > 0,
};
```

8. Update `_onRequestSkill` to check for shift-click:
```javascript
static async _onRequestSkill(event, target) {
  const skillSlug = target.dataset.skill;
  if (!skillSlug) return;

  // Check for shift-click multi-select
  if (event.shiftKey) {
    const handled = this._toggleSkillSelection(skillSlug, true);
    if (handled) return; // Selection handled, don't request roll
  }

  // Existing behavior for regular click
  if (this.selectedParticipants.size === 0) {
    ui.notifications.warn('No PCs selected');
    return;
  }

  await this._requestSkillCheck(skillSlug, Array.from(this.selectedParticipants));
}
```
  </action>
  <verify>
Code review: `selectedSkills` Set initialized in constructor. Shift+click toggles selection without triggering roll. Selection clears when participants change.
  </verify>
  <done>
Multi-skill selection state implemented with Set. Shift+click toggles selection. Selection clears automatically when participants change with notification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Lore Skills Aggregation for Multi-PC</name>
  <files>scripts/applications/gm-sidebar-pf2e.mjs</files>
  <action>
Update `_getLoreSkills` in GMSidebarAppPF2e to aggregate lore skills across all selected participants (not just single PC):

1. Find `_getLoreSkills` static method (around line 40-68).

2. Replace the implementation:
```javascript
/**
 * Get lore skills from all selected participants (PF2e specific)
 * Returns union of all lore skills from selected PCs
 * @param {Object} state - Current state
 * @param {Set} selectedParticipants - Set of selected participant IDs
 * @returns {Promise<Array>} Array of lore skill objects
 */
static async _getLoreSkills(state, selectedParticipants) {
  // Return empty if no participants selected
  if (!selectedParticipants?.size) return [];
  if (!state?.participants?.length) return [];

  // Aggregate lore skills from ALL selected participants
  const loreMap = new Map(); // slug -> { slug, name, isLore, participantIds }

  for (const participantId of selectedParticipants) {
    const participant = state.participants.find((p) => p.id === participantId);
    if (!participant) continue;

    const actor = await fromUuid(participant.actorUuid);
    if (!actor?.system?.skills) continue;

    // PF2e stores lore skills with keys containing "-lore"
    for (const [key, skill] of Object.entries(actor.system.skills)) {
      if (key.includes('-lore') && skill.label) {
        const slug = key.toLowerCase();

        if (loreMap.has(slug)) {
          // Skill already exists, add participant to list
          loreMap.get(slug).participantIds.push(participantId);
        } else {
          // New lore skill
          loreMap.set(slug, {
            slug,
            name: skill.label,
            isLore: true,
            participantIds: [participantId]
          });
        }
      }
    }
  }

  // Convert to sorted array
  return Array.from(loreMap.values())
    .sort((a, b) => a.name.localeCompare(b.name));
}
```

3. The key changes:
   - Removed the `if (selectedParticipants?.size !== 1) return [];` restriction
   - Now iterates over ALL selected participants
   - Tracks which participants have each lore skill (useful for batch requests later)
   - Returns union of all lore skills sorted alphabetically

4. Note: The template already handles `hasLoreSkills` and `loreSkills` - no template changes needed for aggregation to work.
  </action>
  <verify>
In FoundryVTT: Select multiple PCs with different lore skills. Verify lore skills section shows union of all lore skills from selected PCs, not just one PC.
  </verify>
  <done>
Lore skills aggregate across all selected PCs. Selecting multiple PCs shows union of their lore skills. Each lore skill tracks which participants have it.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Selection Visual Feedback in Template and CSS</name>
  <files>templates/gm-sidebar.hbs, styles/gm-sidebar.css</files>
  <action>
Add visual feedback for selected skills and batch request controls:

1. In templates/gm-sidebar.hbs, update skill button rendering to show selected state.

For each category's skill buttons (Physical, Magical, Social, Utility, Lore), add selected class:
```handlebars
<button type="button"
        class="skill-btn {{#if (includes ../selectedSkills this.slug)}}selected{{/if}}"
        ...>
```

Since Handlebars doesn't have a native `includes` helper, we need to pass selected state differently. Update the skill data in _prepareContext to include selection state:

In gm-sidebar.mjs _prepareContext, when building skill arrays, check selection:
```javascript
const skillData = {
  slug,
  name: skill.name,
  shortName: skill.shortName || slug.toUpperCase(),
  selected: this.selectedSkills?.has(slug) || false
};
```

Then in template:
```handlebars
<button type="button"
        class="skill-btn {{#if this.selected}}selected{{/if}}"
        data-action="requestSkill"
        data-skill="{{this.slug}}"
        ...>
  {{this.shortName}}
</button>
```

2. Add the same `selected` property to lore skills in _prepareContext when calling _getLoreSkills, then mapping results:
```javascript
const loreSkills = await this.constructor._getLoreSkills(state, this.selectedParticipants);
const loreSkillsWithSelection = loreSkills.map(skill => ({
  ...skill,
  selected: this.selectedSkills?.has(skill.slug) || false
}));
```

3. In styles/gm-sidebar.css, add selected state styling:
```css
/* Selected skill button */
.gm-sidebar-container .skill-btn.selected {
  background: var(--sf-accent-secondary);
  border: 2px solid var(--sf-accent-secondary-hover);
  box-shadow: 0 0 0 2px rgba(var(--sf-accent-secondary-rgb), 0.3);
}

.gm-sidebar-container .skill-btn.selected:hover {
  background: var(--sf-accent-secondary-hover);
}

.gm-sidebar-container .skill-btn.lore.selected {
  background: rgba(235, 203, 139, 0.4);
  border-color: #ebcb8b;
}
```

4. Add batch request bar in template (after skill sections, before closing check-request-bar):
```handlebars
{{#if hasSelectedSkills}}
<div class="batch-request-bar">
  <span class="selected-skill-count">{{selectedSkills.length}} skill(s) selected</span>
  <div class="batch-actions">
    <button type="button" class="batch-btn clear" data-action="clearSkillSelection" data-tooltip="Clear Selection">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>
{{/if}}
```

5. Add CSS for batch request bar:
```css
/* Batch request bar */
.batch-request-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--sf-bg-elevated);
  border-radius: var(--sf-radius-md);
  margin-top: var(--sf-space-sm);
  border: 1px solid var(--sf-accent-secondary);
}

.batch-request-bar .selected-skill-count {
  font-size: var(--sf-font-sm);
  font-weight: 600;
  color: var(--sf-accent-secondary);
}

.batch-request-bar .batch-actions {
  display: flex;
  gap: 8px;
}

.batch-request-bar .batch-btn {
  padding: 6px 12px;
  border-radius: var(--sf-radius-sm);
  border: none;
  cursor: pointer;
  font-size: var(--sf-font-xs);
  font-weight: 600;
  transition: all var(--sf-transition-fast);
}

.batch-request-bar .batch-btn.clear {
  background: transparent;
  color: var(--sf-text-muted);
  padding: 6px;
}

.batch-request-bar .batch-btn.clear:hover {
  color: var(--sf-danger);
}
```
  </action>
  <verify>
In FoundryVTT: Shift+click skills to select. Verify selected skills show highlighted border/background. Verify batch request bar appears when skills are selected. Verify Clear button clears selection.
  </verify>
  <done>
Selected skills show visual highlight. Batch request bar appears with skill count and clear button. Lore skills also show selected state correctly.
  </done>
</task>

</tasks>

<verification>
1. Open FoundryVTT with StoryFrame module
2. Add multiple PCs with different lore skills as participants
3. Select multiple PCs - verify lore skills section shows union of all their lore skills
4. With participants selected, shift+click on skills - verify they highlight as selected
5. Shift+click on already selected skill - verify it deselects
6. Verify batch request bar appears showing "X skill(s) selected"
7. Click Clear button - verify all selections cleared
8. Change participant selection - verify skill selection auto-clears with notification
9. Try to shift+click skill with no participants - verify warning appears
</verification>

<success_criteria>
- Lore skills aggregate across all selected PCs (not just single PC)
- Shift+click toggles skill selection
- Selected skills show highlighted visual state
- Batch request bar appears when skills are selected
- Skill selection clears automatically when participants change
- Selection blocked with warning when no participants selected
</success_criteria>

<output>
After completion, create `.planning/phases/08-skill-ui-and-batch-roll-requests/08-02-SUMMARY.md`
</output>
