---
phase: 08-skill-ui-batch-rolls
plan: 04
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - scripts/applications/gm-sidebar.mjs
  - templates/gm-sidebar.hbs
  - styles/gm-sidebar.css
autonomous: true

must_haves:
  truths:
    - "Each skill supports optional per-skill proficiency filter (not global filter)"
    - "Badge on skill button shows active filter (e.g., 'Expert+')"
    - "Proficiency filter dropdown appears on filter icon click"
    - "Default filter is 'Any' (no restriction)"
  artifacts:
    - path: "scripts/applications/gm-sidebar.mjs"
      provides: "Per-skill proficiency filter state management"
      contains: "skillProficiencyFilters"
    - path: "templates/gm-sidebar.hbs"
      provides: "Proficiency filter UI elements"
      contains: "proficiency-badge"
  key_links:
    - from: "gm-sidebar.mjs"
      to: "templates/gm-sidebar.hbs"
      via: "proficiencyBadge property on skill data"
      pattern: "proficiencyBadge"
---

<objective>
Add per-skill proficiency filtering with visual badges and filter dropdown UI.

Purpose: Allow GMs to set proficiency requirements for individual skills (e.g., require Expert+ Thievery but only Trained+ Athletics), enabling more nuanced skill check requests.

Output: Per-skill proficiency filter state, filter icon buttons on skills, dropdown for selecting proficiency level, and badges showing active filters.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-CONTEXT.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-RESEARCH.md
@.planning/phases/08-skill-ui-and-batch-roll-requests/08-02-SUMMARY.md
@scripts/applications/gm-sidebar.mjs
@scripts/applications/gm-sidebar-pf2e.mjs
@templates/gm-sidebar.hbs
@styles/gm-sidebar.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Per-Skill Proficiency Filter State</name>
  <files>scripts/applications/gm-sidebar.mjs</files>
  <action>
Add proficiency filter state management to GMSidebarAppBase:

1. In constructor, add proficiency filter state (after selectedSkills):
```javascript
// Per-skill proficiency filters (Map: skillSlug -> proficiency rank 0-4)
// 0=Any, 1=Trained, 2=Expert, 3=Master, 4=Legendary
this.skillProficiencyFilters = new Map();
```

2. Add proficiency level constants:
```javascript
static PROFICIENCY_LEVELS = [
  { value: 0, label: 'Any', shortLabel: null },
  { value: 1, label: 'Trained+', shortLabel: 'T+' },
  { value: 2, label: 'Expert+', shortLabel: 'E+' },
  { value: 3, label: 'Master+', shortLabel: 'M+' },
  { value: 4, label: 'Legendary+', shortLabel: 'L+' }
];
```

3. Add method to get proficiency badge text:
```javascript
/**
 * Get badge text for a proficiency level
 * @param {number} level - Proficiency level (0-4)
 * @returns {string|null} Badge text or null if no filter
 */
_getProficiencyBadge(level) {
  if (!level || level === 0) return null;
  const prof = GMSidebarAppBase.PROFICIENCY_LEVELS.find(p => p.value === level);
  return prof?.shortLabel || null;
}
```

4. Add action handlers in DEFAULT_OPTIONS.actions:
```javascript
openProficiencyFilter: GMSidebarAppBase._onOpenProficiencyFilter,
setProficiencyFilter: GMSidebarAppBase._onSetProficiencyFilter,
clearProficiencyFilter: GMSidebarAppBase._onClearProficiencyFilter,
```

5. Add handler to open proficiency filter dropdown:
```javascript
static _onOpenProficiencyFilter(event, target) {
  event.stopPropagation();
  const skillSlug = target.dataset.skill;
  if (!skillSlug) return;

  // Close any existing filter dropdown
  document.querySelector('.proficiency-filter-dropdown')?.remove();

  // Get current filter value for this skill
  const currentFilter = this.skillProficiencyFilters.get(skillSlug) || 0;

  // Create dropdown
  const dropdown = document.createElement('div');
  dropdown.className = 'proficiency-filter-dropdown';
  dropdown.dataset.skill = skillSlug;

  dropdown.innerHTML = `
    <div class="filter-header">
      <span>Proficiency Required</span>
    </div>
    <div class="filter-options">
      ${GMSidebarAppBase.PROFICIENCY_LEVELS.map(level => `
        <button type="button"
                class="filter-option ${level.value === currentFilter ? 'active' : ''}"
                data-action="setProficiencyFilter"
                data-skill="${skillSlug}"
                data-level="${level.value}">
          ${level.label}
        </button>
      `).join('')}
    </div>
  `;

  // Position dropdown near the button
  const rect = target.getBoundingClientRect();
  dropdown.style.position = 'fixed';
  dropdown.style.top = `${rect.bottom + 4}px`;
  dropdown.style.left = `${rect.left}px`;
  dropdown.style.zIndex = '1000';

  document.body.appendChild(dropdown);

  // Adjust if off-screen
  const dropdownRect = dropdown.getBoundingClientRect();
  if (dropdownRect.right > window.innerWidth) {
    dropdown.style.left = `${rect.right - dropdownRect.width}px`;
  }
  if (dropdownRect.bottom > window.innerHeight) {
    dropdown.style.top = `${rect.top - dropdownRect.height - 4}px`;
  }

  // Close on click outside
  const closeHandler = (e) => {
    if (!dropdown.contains(e.target)) {
      dropdown.remove();
      document.removeEventListener('click', closeHandler);
    }
  };
  setTimeout(() => document.addEventListener('click', closeHandler), 10);
}
```

6. Add handler to set proficiency filter:
```javascript
static _onSetProficiencyFilter(event, target) {
  const skillSlug = target.dataset.skill;
  const level = parseInt(target.dataset.level);

  if (level === 0) {
    this.skillProficiencyFilters.delete(skillSlug);
  } else {
    this.skillProficiencyFilters.set(skillSlug, level);
  }

  // Close dropdown
  document.querySelector('.proficiency-filter-dropdown')?.remove();

  this.render();
}
```

7. Update _clearSkillSelection to also clear proficiency filters:
```javascript
_clearSkillSelection() {
  this.selectedSkills.clear();
  this.skillProficiencyFilters.clear(); // Also clear filters
  this.lastSelectedSkill = null;
}
```

8. In _prepareContext, when building skill arrays, add proficiency data:
```javascript
const skillData = {
  slug,
  name: skill.name,
  shortName: skill.shortName || slug.toUpperCase(),
  selected: this.selectedSkills?.has(slug) || false,
  proficiencyFilter: this.skillProficiencyFilters.get(slug) || 0,
  proficiencyBadge: this._getProficiencyBadge(this.skillProficiencyFilters.get(slug))
};
```

9. Do the same for lore skills when mapping them:
```javascript
const loreSkillsWithState = loreSkills.map(skill => ({
  ...skill,
  selected: this.selectedSkills?.has(skill.slug) || false,
  proficiencyFilter: this.skillProficiencyFilters.get(skill.slug) || 0,
  proficiencyBadge: this._getProficiencyBadge(this.skillProficiencyFilters.get(skill.slug))
}));
```
  </action>
  <verify>
Code review: skillProficiencyFilters Map initialized. Handlers for open/set/clear proficiency filter exist. Proficiency data added to skill context objects.
  </verify>
  <done>
Per-skill proficiency filter state implemented with Map. Filter level 0-4 supported. Proficiency data passed to template context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Proficiency Filter UI to Template</name>
  <files>templates/gm-sidebar.hbs</files>
  <action>
Update skill buttons in gm-sidebar.hbs to show filter icon and proficiency badge:

1. For each skill button in the categories (Physical, Magical, Social, Utility), update the template:

```handlebars
<div class="skill-btn-wrapper">
  <button type="button"
          class="skill-btn {{#if this.selected}}selected{{/if}}"
          data-action="requestSkill"
          data-skill="{{this.slug}}"
          data-tooltip="{{this.name}}"
          aria-label="Request {{this.name}} check">
    {{this.shortName}}
    {{#if this.proficiencyBadge}}
      <span class="proficiency-badge">{{this.proficiencyBadge}}</span>
    {{/if}}
  </button>
  <button type="button"
          class="filter-btn"
          data-action="openProficiencyFilter"
          data-skill="{{this.slug}}"
          data-tooltip="Set proficiency requirement"
          aria-label="Set proficiency filter for {{this.name}}">
    <i class="fas fa-filter {{#if this.proficiencyFilter}}active{{/if}}"></i>
  </button>
</div>
```

2. Apply the same pattern to lore skill buttons:
```handlebars
{{#each loreSkills}}
  <div class="skill-btn-wrapper">
    <button type="button"
            class="skill-btn lore {{#if this.selected}}selected{{/if}}"
            data-action="requestSkill"
            data-skill="{{this.slug}}"
            data-tooltip="{{this.name}}"
            aria-label="Request {{this.name}} check">
      {{this.name}}
      {{#if this.proficiencyBadge}}
        <span class="proficiency-badge">{{this.proficiencyBadge}}</span>
      {{/if}}
    </button>
    <button type="button"
            class="filter-btn"
            data-action="openProficiencyFilter"
            data-skill="{{this.slug}}"
            data-tooltip="Set proficiency requirement"
            aria-label="Set proficiency filter for {{this.name}}">
      <i class="fas fa-filter {{#if this.proficiencyFilter}}active{{/if}}"></i>
    </button>
  </div>
{{/each}}
```

3. Note: The wrapper div is necessary to position the filter button relative to the skill button while maintaining grid layout.

4. Consider only showing filter buttons when there are selected skills or when hovering over skill area. For cleaner UX, add conditional:
```handlebars
{{#if ../hasSelectedSkills}}
  <button type="button" class="filter-btn" ...>
{{else}}
  <button type="button" class="filter-btn hidden-until-hover" ...>
{{/if}}
```

Or simply always show the filter button but style it subtle until hovered.
  </action>
  <verify>
Review template: Skill buttons wrapped in container with filter button. Proficiency badge conditionally shown. Filter icon visible on each skill.
  </verify>
  <done>
Template updated with proficiency filter UI. Each skill has filter icon button and optional proficiency badge.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Proficiency Filter CSS Styles</name>
  <files>styles/gm-sidebar.css</files>
  <action>
Add CSS for proficiency filter UI elements:

1. Skill button wrapper for positioning:
```css
/* Skill button wrapper */
.skill-btn-wrapper {
  position: relative;
  display: flex;
  align-items: stretch;
}

.skill-btn-wrapper .skill-btn {
  flex: 1;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.skill-btn-wrapper .filter-btn {
  padding: 4px 6px;
  background: rgba(255, 255, 255, 0.05);
  border: none;
  border-left: 1px solid rgba(255, 255, 255, 0.1);
  border-top-right-radius: var(--sf-radius-md);
  border-bottom-right-radius: var(--sf-radius-md);
  color: var(--sf-text-muted);
  cursor: pointer;
  font-size: 10px;
  transition: all var(--sf-transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.skill-btn-wrapper .filter-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--sf-accent-primary);
}

.skill-btn-wrapper .filter-btn i.active {
  color: var(--sf-accent-secondary);
}

.skill-btn-wrapper .filter-btn.hidden-until-hover {
  opacity: 0;
  width: 0;
  padding: 0;
  overflow: hidden;
}

.skill-btn-wrapper:hover .filter-btn.hidden-until-hover {
  opacity: 1;
  width: auto;
  padding: 4px 6px;
}
```

2. Proficiency badge on skill button:
```css
/* Proficiency badge */
.skill-btn .proficiency-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  font-size: 8px;
  font-weight: 700;
  padding: 2px 4px;
  background: var(--sf-accent-secondary);
  color: var(--sf-bg-primary);
  border-radius: 3px;
  line-height: 1;
  pointer-events: none;
}

.skill-btn-wrapper .skill-btn {
  position: relative;
}
```

3. Proficiency filter dropdown:
```css
/* Proficiency filter dropdown */
.proficiency-filter-dropdown {
  background: var(--sf-bg-primary);
  border: 1px solid var(--sf-border-medium);
  border-radius: var(--sf-radius-md);
  box-shadow: var(--sf-shadow-lg);
  min-width: 120px;
  overflow: hidden;
}

.proficiency-filter-dropdown .filter-header {
  padding: 8px 12px;
  font-size: var(--sf-font-xs);
  font-weight: 600;
  color: var(--sf-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--sf-border-subtle);
  background: var(--sf-bg-hover);
}

.proficiency-filter-dropdown .filter-options {
  display: flex;
  flex-direction: column;
}

.proficiency-filter-dropdown .filter-option {
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: var(--sf-font-sm);
  color: var(--color-text-light-primary);
  transition: background var(--sf-transition-fast);
}

.proficiency-filter-dropdown .filter-option:hover {
  background: var(--sf-bg-hover);
}

.proficiency-filter-dropdown .filter-option.active {
  background: var(--sf-accent-primary);
  color: white;
}

.proficiency-filter-dropdown .filter-option.active:hover {
  background: var(--sf-accent-primary-hover);
}
```

4. Update skill grid to accommodate wrappers:
```css
/* Update skill grid for wrappers */
.skill-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); /* Slightly wider for filter button */
  gap: 6px;
  margin-bottom: 8px;
}
```
  </action>
  <verify>
In FoundryVTT: Click filter icon on a skill. Verify dropdown appears with proficiency options. Select "Expert+" - verify dropdown closes and badge "E+" appears on skill button.
  </verify>
  <done>
Proficiency filter CSS complete. Filter dropdown styled, badges positioned correctly, filter icon shows active state when filter is set.
  </done>
</task>

</tasks>

<verification>
1. Open FoundryVTT with StoryFrame module
2. Add PCs as participants and select some
3. Click filter icon (funnel) on a skill button
4. Verify dropdown appears with options: Any, Trained+, Expert+, Master+, Legendary+
5. Select "Expert+" - verify badge "E+" appears on skill button
6. Select another skill filter - verify different badge appears
7. Click on skill with filter while shift-held - verify skill is selected with its filter
8. Clear skill selection - verify proficiency filters are also cleared
9. Click "Any" option - verify badge disappears from skill button
</verification>

<success_criteria>
- Each skill has filter icon button
- Clicking filter shows dropdown with proficiency options
- Selecting proficiency adds badge to skill button (T+, E+, M+, L+)
- "Any" removes badge
- Clearing skill selection also clears proficiency filters
- Filter state persists during re-renders
</success_criteria>

<output>
After completion, create `.planning/phases/08-skill-ui-and-batch-roll-requests/08-04-SUMMARY.md`
</output>
