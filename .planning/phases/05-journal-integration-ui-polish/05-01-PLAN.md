---
phase: 05-journal-integration-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/css-scraper.mjs
  - scripts/applications/gm-interface.mjs
  - storyframe.mjs
  - templates/gm-interface.hbs
autonomous: true

must_haves:
  truths:
    - "Journal custom styles render in StoryFrame content area"
    - "Styles update when GM edits journal while StoryFrame open"
    - "Extracted styles don't affect other Foundry UI"
    - "Base Foundry styles apply when journal has no custom CSS"
  artifacts:
    - path: "scripts/css-scraper.mjs"
      provides: "CSS extraction and namespacing utility"
      exports: ["CSSScraper"]
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Style injection lifecycle"
      contains: "_updateJournalStyles"
    - path: "storyframe.mjs"
      provides: "Journal update hook watchers"
      contains: "closeJournalSheet"
  key_links:
    - from: "gm-interface.mjs"
      to: "css-scraper.mjs"
      via: "import and instantiate"
      pattern: "import.*CSSScraper"
    - from: "storyframe.mjs"
      to: "gm-interface._updateJournalStyles"
      via: "hook callback"
      pattern: "Hooks\\.on\\('closeJournalSheet'"
---

<objective>
Extract journal CSS and apply to StoryFrame content area with proper namespacing.

Purpose: Journal custom styles (from modules like Monk's Enhanced Journal) should render correctly in StoryFrame, matching native journal appearance.
Output: css-scraper.mjs utility, style injection in GM interface, hook watchers for re-scraping
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-journal-integration-ui-polish/05-RESEARCH.md
@scripts/applications/gm-interface.mjs
@storyframe.mjs
@templates/gm-interface.hbs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSS scraper utility</name>
  <files>scripts/css-scraper.mjs</files>
  <action>
Create scripts/css-scraper.mjs with CSSScraper class:

1. extractJournalCSS(journal) method:
   - Iterate document.styleSheets via CSSOM
   - Extract cssRules from each accessible sheet
   - Handle CORS errors with try-catch (skip inaccessible)
   - Return concatenated CSS text
   - Cache results by journal.uuid

2. namespaceCSSRules(cssText, namespace = '.storyframe-content') method:
   - Parse CSS into individual rules (handle nested braces correctly)
   - Skip @-rules (media queries, keyframes - they scope themselves)
   - Prefix each selector with namespace
   - Handle comma-separated selectors
   - Return namespaced CSS string

3. clearCache(journalUuid) and clearAllCache() methods for invalidation

Export class as named export.

See RESEARCH.md Pattern 1-2 for implementation details.
  </action>
  <verify>
File exists at scripts/css-scraper.mjs with CSSScraper class exported.
No syntax errors: `node --check scripts/css-scraper.mjs` (if Node available) or visual inspection.
  </verify>
  <done>
CSSScraper class with extractJournalCSS, namespaceCSSRules, clearCache, clearAllCache methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate scraper into GM interface and add hooks</name>
  <files>scripts/applications/gm-interface.mjs, storyframe.mjs, templates/gm-interface.hbs</files>
  <action>
**gm-interface.mjs changes:**

1. Import CSSScraper at top:
   ```javascript
   import { CSSScraper } from '../css-scraper.mjs';
   ```

2. In constructor, initialize:
   ```javascript
   this.cssScraper = new CSSScraper();
   this.styleElement = null;
   ```

3. Add _updateJournalStyles(journalUuid) method:
   - Get journal via fromUuid
   - Extract CSS via this.cssScraper.extractJournalCSS
   - Namespace via this.cssScraper.namespaceCSSRules
   - Create/update style element in document.head (id: 'storyframe-journal-styles')
   - Set textContent to namespaced CSS

4. Add _clearJournalStyles() method:
   - Clear styleElement.textContent if exists

5. In _onRender, after super call:
   - If context.selectedJournal: call _updateJournalStyles(context.selectedJournal)
   - Else: call _clearJournalStyles()

6. In _onClose, clean up:
   - Remove styleElement from document if exists
   - Set this.styleElement = null

**gm-interface.hbs changes:**

Wrap journal content with .storyframe-content class for CSS scoping:
- Find the `<section class="journal-page-content">` element
- Add `storyframe-content` to its classes:
  ```handlebars
  <section class="journal-page-content storyframe-content">
  ```

**storyframe.mjs changes:**

Add hooks for re-scraping when journal edited. Use closeJournalSheet hook (fires when editor closes after edits, guaranteeing styles are finalized):

1. After the ready hook (near bottom), add:
   ```javascript
   // Watch for journal document updates (content changes)
   Hooks.on('updateJournalEntry', async (journal, changed, options, userId) => {
     const state = game.storyframe.stateManager.getState();
     if (journal.uuid !== state?.activeJournal) return;

     // Clear cache for updated journal
     if (game.storyframe.gmApp?.cssScraper) {
       game.storyframe.gmApp.cssScraper.clearCache(journal.uuid);
     }

     // Re-scrape and inject
     if (game.user.isGM && game.storyframe.gmApp?.rendered) {
       await game.storyframe.gmApp._updateJournalStyles(journal.uuid);
     }
   });
   ```

2. Add closeJournalSheet hook for CSS changes (reliable - fires after editor fully closed):
   ```javascript
   Hooks.on('closeJournalSheet', async (sheet, html) => {
     const state = game.storyframe.stateManager.getState();
     if (sheet.document.uuid !== state?.activeJournal) return;

     // Clear cache - styles may have changed
     if (game.storyframe.gmApp?.cssScraper) {
       game.storyframe.gmApp.cssScraper.clearCache(sheet.document.uuid);
     }

     // Re-scrape with delay to ensure stylesheets detached/updated
     setTimeout(async () => {
       if (game.user.isGM && game.storyframe.gmApp?.rendered) {
         await game.storyframe.gmApp._updateJournalStyles(sheet.document.uuid);
       }
     }, 200);
   });
   ```

Note: closeJournalSheet is preferred over renderJournalSheet because:
- Fires once when editor closes (not on every re-render)
- CSS changes are finalized at this point
- No race conditions with stylesheets still loading
  </action>
  <verify>
1. Load Foundry, select journal with custom styles in StoryFrame
2. Verify styles apply (check if content looks like native journal)
3. Open journal editor, make CSS-affecting changes, close editor
4. Verify StoryFrame styles update after editor closes
5. Select different journal, verify old styles cleared
6. Close StoryFrame, verify no orphan style element in document.head
  </verify>
  <done>
Journal styles extracted, namespaced, and injected into StoryFrame.
Styles re-scrape on journal close (after edits finalized).
No style leakage to other Foundry UI.
  </done>
</task>

</tasks>

<verification>
- [ ] css-scraper.mjs exists with CSSScraper class
- [ ] GM interface imports and uses CSSScraper
- [ ] Template has .storyframe-content wrapper on content
- [ ] Hooks registered for updateJournalEntry and closeJournalSheet
- [ ] Custom journal styles render in StoryFrame
- [ ] Styles don't affect other Foundry windows
- [ ] Styles update when journal editor closes
</verification>

<success_criteria>
- Journal with custom CSS (e.g., Monk's Enhanced Journal) renders styled in StoryFrame
- Plain journal renders with Foundry base styles
- No style pollution outside .storyframe-content
- Closing journal editor updates StoryFrame appearance within 500ms
</success_criteria>

<output>
After completion, create `.planning/phases/05-journal-integration-ui-polish/05-01-SUMMARY.md`
</output>
