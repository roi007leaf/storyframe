---
phase: 05-journal-integration-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/applications/gm-interface.mjs
  - styles/design-tokens.css
autonomous: true

must_haves:
  truths:
    - "GM can click edit button to open journal's native editor"
    - "Edit button disabled/hidden when no journal selected"
    - "Images dragged from journal content can be added as speakers"
    - "Design tokens CSS loaded and available for styling"
  artifacts:
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Edit button via HEADER_ACTIONS"
      contains: "HEADER_ACTIONS"
    - path: "styles/design-tokens.css"
      provides: "Typography, spacing, animation tokens"
      contains: "--sf-"
  key_links:
    - from: "gm-interface.mjs HEADER_ACTIONS"
      to: "journal.sheet.render()"
      via: "_onEditJournal callback"
      pattern: "journal\\.sheet\\.render"
---

<objective>
Add GM edit workflow, verify drag-drop, create design foundation.

Purpose: GM needs quick access to edit journal without leaving StoryFrame. Design tokens establish consistent visual language.
Output: Edit button in header, verified drag-drop, design-tokens.css
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-journal-integration-ui-polish/05-RESEARCH.md
@scripts/applications/gm-interface.mjs
@styles/gm-interface.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit journal button via HEADER_ACTIONS</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Add HEADER_ACTIONS static property to GMInterfaceApp class (after DEFAULT_OPTIONS, before PARTS):

```javascript
static HEADER_ACTIONS = {
  editJournal: {
    icon: 'fas fa-edit',
    label: 'Edit Journal',
    onclick: function() {
      this._onEditJournal();
    }
  }
};
```

Add _onEditJournal method to the class:

```javascript
async _onEditJournal() {
  const state = game.storyframe.stateManager.getState();
  if (!state?.activeJournal) {
    ui.notifications.warn('No journal selected');
    return;
  }

  const journal = await fromUuid(state.activeJournal);
  if (!journal) {
    ui.notifications.error('Journal not found');
    return;
  }

  // Open native journal editor
  journal.sheet.render(true);
}
```

The button will appear in window header automatically via ApplicationV2's HEADER_ACTIONS pattern.
  </action>
  <verify>
1. Open StoryFrame GM interface
2. Verify edit button (pencil icon) appears in window header
3. Click button with no journal selected - expect warning notification
4. Select journal, click button - expect journal sheet opens
5. Edit journal content, close journal - StoryFrame shows updated content
  </verify>
  <done>
Edit button in header opens journal's native editor.
Warning shown when no journal selected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and fix drag-drop for images</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Review existing drag-drop implementation in _attachContentImageDrag() and _attachDragDropHandlers().

Current implementation:
- Images get draggable=true and dragstart listener
- dragstart sets StoryFrameImage data
- Gallery has dragover/drop handlers
- Drop parses StoryFrameImage, prompts for name, calls requestAddSpeaker

**Verification steps** (test in Foundry):
1. Open StoryFrame, select journal with images
2. Try dragging image from content to speaker gallery
3. Verify dialog appears, enter name, confirm speaker added

**If broken, likely fixes:**
- Ensure img.draggable = true is set
- Verify dragstart event.dataTransfer.setData is correct
- Check drop handler parses JSON correctly
- Ensure _attachContentImageDrag called in _onRender

**If working but could be improved:**
- Add visual feedback: drop zone border highlight
- Add cursor: grab/grabbing on images

Review code and apply any necessary fixes. If working correctly, add comment noting it was verified.
  </action>
  <verify>
1. Drag image from journal content to speaker gallery
2. Dialog prompts for name
3. Speaker appears with image and entered name
4. Drag actor from sidebar - still works (regression check)
  </verify>
  <done>
Images from journal content can be dragged and added as speakers.
Actor drag-drop still functional.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create design tokens CSS</name>
  <files>styles/design-tokens.css</files>
  <action>
Create styles/design-tokens.css with comprehensive design system tokens.

**Also update module.json** to include new CSS file in styles array.

```css
/* StoryFrame Design Tokens
 * Foundation for consistent, polished UI
 * Inspired by Arc browser aesthetic - subtle, refined, professional
 */

:root {
  /* === Typography Scale (1.25 ratio) === */
  --sf-font-xs: 0.75rem;     /* 12px - labels, hints */
  --sf-font-sm: 0.875rem;    /* 14px - secondary text */
  --sf-font-base: 1rem;      /* 16px - body text */
  --sf-font-lg: 1.25rem;     /* 20px - section titles */
  --sf-font-xl: 1.563rem;    /* 25px - page headers */
  --sf-font-2xl: 1.953rem;   /* 31px - main titles */

  /* === Line Heights === */
  --sf-leading-tight: 1.3;   /* Headings */
  --sf-leading-base: 1.5;    /* UI elements */
  --sf-leading-relaxed: 1.6; /* Body/reading text */

  /* === Spacing Scale (8px base) === */
  --sf-space-xs: 0.25rem;    /* 4px - tight gaps */
  --sf-space-sm: 0.5rem;     /* 8px - compact spacing */
  --sf-space-md: 1rem;       /* 16px - standard padding */
  --sf-space-lg: 1.5rem;     /* 24px - section gaps */
  --sf-space-xl: 2rem;       /* 32px - major sections */
  --sf-space-2xl: 3rem;      /* 48px - page margins */

  /* === Content Width (for readability) === */
  --sf-content-width: 66ch;  /* Optimal reading width */
  --sf-content-padding: var(--sf-space-xl);

  /* === Border Radius === */
  --sf-radius-sm: 4px;       /* Small elements */
  --sf-radius-md: 6px;       /* Buttons, inputs */
  --sf-radius-lg: 8px;       /* Cards, panels */
  --sf-radius-full: 9999px;  /* Pills, circles */

  /* === Transitions === */
  --sf-transition-fast: 100ms;   /* Click feedback */
  --sf-transition-base: 200ms;   /* Hover states */
  --sf-transition-slow: 300ms;   /* Layout changes */
  --sf-ease-out: ease-out;
  --sf-ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);

  /* === Shadows (layered for depth) === */
  --sf-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
  --sf-shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
  --sf-shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.2);
  --sf-shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.25);
  --sf-shadow-focus: 0 0 0 3px var(--color-text-hyperlink);

  /* === Color Adjustments (enhance Foundry's palette) === */
  --sf-bg-elevated: rgba(255, 255, 255, 0.03);
  --sf-bg-hover: rgba(255, 255, 255, 0.06);
  --sf-border-subtle: rgba(255, 255, 255, 0.08);
  --sf-text-muted: rgba(255, 255, 255, 0.6);
}

/* === Utility Classes === */

/* GPU-accelerated transforms for smooth animations */
.sf-animate {
  will-change: transform, opacity;
}

/* Fade in on render */
@keyframes sf-fade-in {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.sf-fade-in {
  animation: sf-fade-in var(--sf-transition-slow) var(--sf-ease-out);
}
```

**Update module.json:**
Add to styles array (before gm-interface.css and player-viewer.css):
```json
"styles": [
  "styles/design-tokens.css",
  "styles/gm-interface.css",
  "styles/player-viewer.css"
]
```
  </action>
  <verify>
1. File exists at styles/design-tokens.css
2. module.json includes design-tokens.css in styles array
3. Load Foundry - no CSS errors in console
4. Inspect element in browser - CSS variables visible in :root
  </verify>
  <done>
Design tokens CSS created with typography, spacing, radius, transition, and shadow variables.
Module.json updated to load new stylesheet.
  </done>
</task>

</tasks>

<verification>
- [ ] Edit button appears in GM interface header
- [ ] Edit button opens journal sheet
- [ ] Edit button shows warning when no journal
- [ ] Image drag-drop works from content to gallery
- [ ] Actor drag-drop still works
- [ ] design-tokens.css created with all token categories
- [ ] module.json updated with new stylesheet
- [ ] No console errors on Foundry load
</verification>

<success_criteria>
- GM can quickly edit journal via header button
- Full drag-drop functionality for images and actors
- Design tokens available for use in subsequent styling
</success_criteria>

<output>
After completion, create `.planning/phases/05-journal-integration-ui-polish/05-02-SUMMARY.md`
</output>
