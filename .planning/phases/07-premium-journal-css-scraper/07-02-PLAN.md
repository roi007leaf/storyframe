---
phase: 07-premium-journal-css-scraper
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - storyframe.mjs
  - scripts/css-scraper.mjs
  - scripts/applications/gm-interface.mjs
autonomous: false

must_haves:
  truths:
    - "CSS class cache persists across Foundry restarts"
    - "Temporary journal sheets close reliably after extraction"
    - "Switching journals updates CSS without stale styles"
    - "Premium module styling visually matches native journals"
  artifacts:
    - path: "storyframe.mjs"
      provides: "journalClassCache setting registration"
      contains: "journalClassCache"
    - path: "scripts/css-scraper.mjs"
      provides: "Settings-based cache read/write"
      contains: "game.settings.get"
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Reliable class extraction with try-finally cleanup"
      contains: "finally"
  key_links:
    - from: "scripts/css-scraper.mjs"
      to: "game.settings"
      via: "Foundry Settings API"
      pattern: "game\\.settings\\.(get|set)"
    - from: "scripts/applications/gm-interface.mjs"
      to: "scripts/css-scraper.mjs"
      via: "extractJournalCSS call with extractedClass"
      pattern: "cssScraper\\.extractJournalCSS"
---

<objective>
Add settings-based cache persistence and fix GMInterface extraction reliability, then verify visual styling matches premium modules.

Purpose: Current in-memory cache is lost on restart, and temporary journal sheets sometimes don't close. This plan adds persistence and reliability, then verifies the full integration works visually.

Output: Persistent cache, reliable extraction, and verified premium journal styling.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-premium-journal-css-scraper/07-RESEARCH.md
@.planning/phases/07-premium-journal-css-scraper/07-CONTEXT.md
@.planning/phases/07-premium-journal-css-scraper/07-01-SUMMARY.md
@scripts/css-scraper.mjs
@scripts/applications/gm-interface.mjs
@storyframe.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings-based cache persistence</name>
  <files>storyframe.mjs, scripts/css-scraper.mjs</files>
  <action>
**In storyframe.mjs** - Register new setting in the init hook settings section:

```javascript
game.settings.register(MODULE_ID, 'journalClassCache', {
  scope: 'client',
  config: false,
  type: Object,
  default: {}
});
```

**In scripts/css-scraper.mjs** - Update CSSScraper to use settings:

1. **Add methods to read/write from settings**:
   ```javascript
   _loadCacheFromSettings() {
     if (typeof game === 'undefined' || !game.settings) return;
     try {
       const saved = game.settings.get('storyframe', 'journalClassCache');
       if (saved && typeof saved === 'object') {
         for (const [uuid, cssText] of Object.entries(saved)) {
           this.cache.set(uuid, cssText);
         }
       }
     } catch (e) {
       console.debug('CSSScraper | Could not load cache from settings');
     }
   }

   async _saveCacheToSettings() {
     if (typeof game === 'undefined' || !game.settings) return;
     try {
       const cacheObj = Object.fromEntries(this.cache);
       await game.settings.set('storyframe', 'journalClassCache', cacheObj);
     } catch (e) {
       console.debug('CSSScraper | Could not save cache to settings');
     }
   }
   ```

2. **Call `_loadCacheFromSettings()` in constructor** (after Map creation)

3. **Call `_saveCacheToSettings()` after setting new cache entries** in `extractJournalCSS()`

4. **Update `clearCache()` and `clearAllCache()`** to also clear the settings cache

Note: Settings operations are async but we don't need to await them in the critical path. Fire-and-forget for writes is fine.
  </action>
  <verify>
Check storyframe.mjs for journalClassCache setting registration.
Check css-scraper.mjs for _loadCacheFromSettings, _saveCacheToSettings methods.
Check that cache is loaded in constructor and saved after extraction.
  </verify>
  <done>
journalClassCache setting registered in storyframe.mjs. CSSScraper loads from settings on init and saves after extraction. Cache persists across Foundry restarts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix GMInterface extraction reliability</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Refactor `_scheduleClassExtraction()` method for reliability:

1. **Add try-finally block** to guarantee sheet closes:
   ```javascript
   async _scheduleClassExtraction(journal) {
     if (this._extractingClassFor === journal.uuid) return;
     this._extractingClassFor = journal.uuid;

     setTimeout(async () => {
       const wasRendered = journal.sheet?.rendered;
       let sheetOpenedByUs = false;

       try {
         // Temporarily render if not already open
         if (!wasRendered) {
           journal.sheet.render(true, { focus: false });
           sheetOpenedByUs = true;
           await new Promise(resolve => setTimeout(resolve, 200)); // Wait for render
         }

         // Extract classes... (existing logic)

       } catch (error) {
         console.error('StoryFrame | Failed to extract journal classes:', error);
       } finally {
         // ALWAYS close if we opened it
         if (sheetOpenedByUs && journal.sheet?.rendered) {
           journal.sheet.close();
         }
         this._extractingClassFor = null;
       }
     }, 100);
   }
   ```

2. **Track whether WE opened the sheet** with `sheetOpenedByUs` flag - don't close user's manually opened journals

3. **Increase wait time** from 150ms to 200ms to ensure DOM is ready

4. **Update class extraction logic** to work with refactored scraper:
   - When calling `this.cssScraper.extractJournalCSS(journal, extractedClass)`, pass the extracted class
   - After extracting class from DOM, call `this.cssScraper.extractJournalCSS(journal, extractedClass)` to get filtered CSS

5. **Add class cache to GMInterface's journalClassCache AND scraper's cache**:
   - GMInterface.journalClassCache stores the class name (e.g., 'pf2e-km')
   - CSSScraper.cache stores the CSS text
   - Both need to be populated

6. **Clean up old classes before applying new ones** in `_onRender`:
   - Current code removes specific classes manually - keep this approach
   - Make sure the list includes all possible premium module classes
  </action>
  <verify>
Check _scheduleClassExtraction for:
- try-finally block with sheet.close() in finally
- sheetOpenedByUs flag tracking
- 200ms timeout for render wait
- extractedClass passed to cssScraper.extractJournalCSS
  </verify>
  <done>
_scheduleClassExtraction uses try-finally to guarantee sheet closure. Sheet only closed if we opened it. Class extraction passes extractedClass to CSS scraper for proper filtering.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of premium journal styling</name>
  <what-built>
Complete CSS scraper refactor with:
- Hybrid filtering (URL + keywords) to reduce CSS payload
- Selective namespacing that preserves complex selectors
- Settings-based cache persistence
- Reliable temporary sheet cleanup
  </what-built>
  <how-to-verify>
1. Start Foundry VTT and load a world with premium module journals (Kingmaker, PFS, etc.)

2. Open StoryFrame (GM interface)

3. Select a Kingmaker journal from compendium or world:
   - EXPECTED: Styling matches native Kingmaker journal appearance
   - EXPECTED: No 200KB+ CSS in network/inspector

4. Select a PFS (Pathfinder Society) journal:
   - EXPECTED: Distinctive teal/turquoise sidebar visible
   - EXPECTED: Styling switches cleanly from Kingmaker

5. Select a world journal (imported from a premium pack):
   - EXPECTED: Retains original premium module styling
   - EXPECTED: No fallback to generic pf2e styling

6. Reload Foundry and re-open StoryFrame:
   - EXPECTED: Styling applies immediately (cache loaded from settings)
   - EXPECTED: No temporary journal windows flash open

7. Check browser console for errors:
   - EXPECTED: No CSS-related errors
   - EXPECTED: No "cannot read property" errors from jQuery collections
  </how-to-verify>
  <resume-signal>Type "approved" if styling matches native journals, or describe visual issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. CSS class cache persists in Foundry settings
2. Temporary journal sheets close reliably (no orphaned windows)
3. Premium module journals display with correct styling
4. Switching between modules updates CSS cleanly
</verification>

<success_criteria>
- Kingmaker journals display Kingmaker styling
- PFS journals display PFS styling with teal sidebar
- World journals maintain original premium module styling
- Cache survives Foundry restart
- No console errors related to CSS or jQuery
</success_criteria>

<output>
After completion, create `.planning/phases/07-premium-journal-css-scraper/07-02-SUMMARY.md`
</output>
