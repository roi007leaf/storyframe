---
phase: 07-premium-journal-css-scraper
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/css-scraper.mjs
  - scripts/applications/gm-interface.mjs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CSS extraction waits for premium module stylesheets to be injected into document"
    - "extractedClass is determined BEFORE CSS extraction begins (not after)"
    - "Premium module CSS rules are found and extracted (not just 6 generic rules)"
    - "Kingmaker-specific CSS (from pf2e-kingmaker-tools) appears in extracted payload"
  artifacts:
    - path: "scripts/css-scraper.mjs"
      provides: "extractJournalCSS with stylesheet detection from rendered sheet"
      contains: "adoptedStyleSheets"
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Class extraction and CSS update in correct order"
      contains: "await.*extractedClass.*before.*extractJournalCSS"
  key_links:
    - from: "gm-interface.mjs _scheduleClassExtraction"
      to: "cssScraper.extractJournalCSS"
      via: "extractedClass parameter passed synchronously after class determined"
      pattern: "const extractedClass.*\\n.*extractJournalCSS.*extractedClass"
    - from: "cssScraper.extractJournalCSS"
      to: "journal.sheet stylesheets"
      via: "Extract from rendered sheet's link elements or adoptedStyleSheets"
      pattern: "sheet\\.element|adoptedStyleSheets|querySelectorAll.*link"
---

<objective>
Fix the CSS extraction timing and source so premium module stylesheets are correctly captured.

Purpose: The diagnostic logs show extractedClass is "none" during first extraction, then "pf2e-km" on second - proving CSS extracts BEFORE class is known. Additionally, premium module CSS (e.g., modules/pf2e-kingmaker-tools/styles/km.css) is NOT in document.styleSheets because it loads dynamically when journal sheets render.

Output: CSS scraper that waits for premium stylesheets and extracts them from the correct source.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-premium-journal-css-scraper/07-01-SUMMARY.md
@.planning/phases/07-premium-journal-css-scraper/07-02-SUMMARY.md
@.planning/phases/07-premium-journal-css-scraper/07-VERIFICATION.md
@.planning/phases/07-premium-journal-css-scraper/07-RESEARCH.md
@scripts/css-scraper.mjs
@scripts/applications/gm-interface.mjs
</context>

<diagnostic_data>
User provided these console logs showing the problem:

```
css-scraper.mjs:55 CSSScraper | Extracted class: none (FIRST extraction - too early!)
css-scraper.mjs:55 CSSScraper | Extracted class: pf2e-km (SECOND extraction - correct!)
css-scraper.mjs:186 CSSScraper | Total rules examined: 654, matched: 6
css-scraper.mjs:187 CSSScraper | Final CSS payload: 270180 characters
css-scraper.mjs:115 CSSScraper | Processing 12 stylesheets
```

Key insights:
1. First extraction has extractedClass = "none", making primaryKeywords empty
2. When primaryKeywords is empty, the check `matchesPrimary = primaryKeywords.length === 0 || ...` is TRUE for ALL rules
3. This causes 270KB of CSS (all journal-related rules) instead of filtered Kingmaker rules
4. Only 6 rules matched when extractedClass was "pf2e-km" - this means Kingmaker CSS isn't in document.styleSheets
5. Premium module stylesheets load dynamically when journal sheet ApplicationV2 renders - they're NOT in document.styleSheets until then
</diagnostic_data>

<tasks>

<task type="auto">
  <name>Task 1: Fix extraction ordering in GMInterface</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
The current flow in _scheduleClassExtraction and _updateJournalStyles has a race condition:
- _updateJournalStyles calls extractJournalCSS immediately (with null extractedClass)
- _scheduleClassExtraction runs async later and extracts the class
- This causes the "none" then "pf2e-km" double extraction

Fix the ordering so CSS extraction only happens AFTER class is determined:

1. In _updateJournalStyles (around line 1141):
   - Check if extractedClass is already cached
   - If NOT cached, trigger _scheduleClassExtraction and return early (don't extract CSS yet)
   - The re-render after _scheduleClassExtraction will call _updateJournalStyles again with cached class

2. In _scheduleClassExtraction (around line 518):
   - After extracting the class and caching it, call _updateJournalStyles directly
   - Remove the render() call at line 597 - _updateJournalStyles will handle the CSS injection

3. Add a flag to prevent multiple simultaneous CSS updates:
   - Add `this._cssUpdatePending = false` in constructor
   - Set it true at start of _updateJournalStyles, false at end
   - Early return if already pending

Key changes:
- Move the extractJournalCSS call to ONLY happen when extractedClass is known
- Ensure the ordering is: render -> determine class -> extract CSS with class -> inject CSS
- Log the ordering clearly: "GMInterface | CSS extraction deferred - awaiting class determination"
  </action>
  <verify>
Console shows NO "Extracted class: null" logs. Every extraction shows a real class like "pf2e-km".
Only ONE extraction per journal selection (not two).
  </verify>
  <done>
extractedClass is never null when extractJournalCSS is called. No duplicate extractions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract CSS from rendered journal sheet's stylesheets</name>
  <files>scripts/css-scraper.mjs</files>
  <action>
The premium module stylesheets (e.g., modules/pf2e-kingmaker-tools/styles/km.css) are NOT in document.styleSheets.
They are injected when the journal sheet ApplicationV2 renders, either:
- As link elements in the sheet's element
- In the sheet's adoptedStyleSheets (if using shadow DOM or adopted stylesheets)
- Added to document.styleSheets AFTER the sheet renders

Update extractJournalCSS to also search for stylesheets in the rendered journal sheet:

1. Add a new optional parameter: `sheetElement` (the rendered journal sheet's DOM element)

2. If sheetElement is provided, search for stylesheets IN the sheet:
   ```javascript
   // Check for link elements in the sheet
   const linkElements = sheetElement.querySelectorAll('link[rel="stylesheet"]');
   for (const link of linkElements) {
     const href = link.href;
     // Link elements may not yet be in document.styleSheets - wait for load or fetch directly
   }
   ```

3. **CRITICAL: Handle the timing gap for link stylesheets:**
   Premium module link stylesheets may not be in document.styleSheets immediately after render.
   Use one of these strategies:

   **Strategy A (Preferred): Wait for link load events**
   ```javascript
   async function waitForLinkStylesheets(linkElements, timeoutMs = 2000) {
     const promises = Array.from(linkElements).map(link => {
       // Check if already loaded (has matching entry in document.styleSheets)
       const alreadyLoaded = Array.from(document.styleSheets).some(s => s.href === link.href);
       if (alreadyLoaded) return Promise.resolve();

       // Wait for load event or timeout
       return new Promise(resolve => {
         const timeout = setTimeout(resolve, timeoutMs);
         link.addEventListener('load', () => {
           clearTimeout(timeout);
           resolve();
         }, { once: true });
       });
     });
     await Promise.all(promises);
   }
   ```

   **Strategy B (Fallback): Fetch CSS content directly**
   ```javascript
   // If link isn't in document.styleSheets after waiting, fetch it directly
   const response = await fetch(link.href);
   const cssText = await response.text();
   // Parse cssText manually or create a CSSStyleSheet from it
   ```

4. Add debug logging to show WHERE stylesheets are found:
   - "CSSScraper | Found link stylesheet in sheet element: [href]"
   - "CSSScraper | Waiting for [N] link stylesheets to load..."
   - "CSSScraper | Link stylesheet loaded: [href]"
   - "CSSScraper | Found adopted stylesheet in sheet"
   - "CSSScraper | Processing document.styleSheets: [count]"

5. Specifically look for premium module stylesheet URLs:
   - modules/pf2e-kingmaker-tools/styles/
   - modules/pf2e-pfs/styles/
   - modules/pf2e-beginner-box/styles/

6. Log when a premium module stylesheet is found:
   - "CSSScraper | FOUND premium module stylesheet: [href]"
  </action>
  <verify>
Console shows "FOUND premium module stylesheet" log when opening Kingmaker journal.
Console shows "Waiting for [N] link stylesheets to load" or "Link stylesheet loaded" messages.
More than 6 rules are matched (should see 50+ rules from premium CSS).
CSS payload is reasonable size (10-50KB, not 270KB).
  </verify>
  <done>
Premium module stylesheets are found and their rules extracted. Link stylesheets are waited for or fetched. CSS payload contains Kingmaker-specific rules.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update GMInterface to pass sheet element to CSS scraper</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Now that the CSS scraper can accept a sheetElement parameter, update GMInterface to pass it:

1. In _scheduleClassExtraction, after waiting for sheet render:
   - Get the DOM element from the journal sheet
   - Store it for use in CSS extraction
   - Pass it to extractJournalCSS: `this.cssScraper.extractJournalCSS(journal, extractedClass, domElement)`

2. In _updateJournalStyles, if the journal sheet is rendered:
   - Get the sheet's DOM element
   - Pass it to extractJournalCSS

3. Add logging to confirm sheet element is being passed:
   - "GMInterface | Passing sheet element to CSS scraper"
   - "GMInterface | Sheet element tag: [tagName], classes: [classList]"

4. Handle case where sheet is NOT rendered (fallback to document.styleSheets only):
   - "GMInterface | Sheet not rendered, using document.styleSheets only"
  </action>
  <verify>
Console shows "Passing sheet element to CSS scraper" log.
CSS extraction finds premium module stylesheets.
Visual styling for Kingmaker journals now works.
  </verify>
  <done>
Sheet element is passed to CSS scraper. Premium module CSS is extracted and applied correctly.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Open StoryFrame and select a Kingmaker journal
2. Check console for extraction logs:
   - "Extracted class: pf2e-km" (NOT null)
   - "Waiting for [N] link stylesheets to load" (if applicable)
   - "FOUND premium module stylesheet: modules/pf2e-kingmaker-tools/..."
   - "Matched [50+] rules" (not just 6)
   - "Final CSS payload: [10-50KB]" (not 270KB)
3. Visual: Kingmaker teal/gold theme should be visible in journal content
</verification>

<success_criteria>
- extractedClass is always determined BEFORE CSS extraction
- Premium module stylesheets are found from rendered journal sheet
- Link stylesheets are waited for (load event) or fetched directly
- CSS payload is filtered to relevant rules (10-50KB, not 270KB)
- Kingmaker visual styling appears in StoryFrame
</success_criteria>

<output>
After completion, create `.planning/phases/07-premium-journal-css-scraper/07-03-SUMMARY.md`
</output>
