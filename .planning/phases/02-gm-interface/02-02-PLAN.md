---
phase: 02-gm-interface
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scripts/applications/gm-interface.mjs
  - storyframe.mjs
autonomous: false

must_haves:
  truths:
    - "GM can open control window from Foundry UI"
    - "Journal dropdown shows all journals, selection updates content"
    - "Drag-drop actor to gallery adds speaker"
    - "Click thumbnail sets active speaker with immediate highlight"
    - "Clear button removes active speaker"
  artifacts:
    - path: "scripts/applications/gm-interface.mjs"
      provides: "GMInterfaceApp ApplicationV2 class"
      exports: ["GMInterfaceApp"]
    - path: "storyframe.mjs"
      provides: "GM button registration and app instantiation"
      contains: "GMInterfaceApp"
  key_links:
    - from: "scripts/applications/gm-interface.mjs"
      to: "templates/gm-interface.hbs"
      via: "PARTS.content.template"
      pattern: "modules/storyframe/templates/gm-interface.hbs"
    - from: "scripts/applications/gm-interface.mjs"
      to: "scripts/socket-manager.mjs"
      via: "game.storyframe.socketManager.request*"
      pattern: "socketManager\\.request"
    - from: "storyframe.mjs"
      to: "scripts/applications/gm-interface.mjs"
      via: "import and instantiation"
      pattern: "import.*GMInterfaceApp"
---

<objective>
Create GMInterfaceApp class with full functionality and UI trigger.

Purpose: Delivers working GM control window for journal reading and speaker management
Output: ApplicationV2 class with all actions, integrated into Foundry UI
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md (SocketManager API)
@.planning/phases/02-gm-interface/02-RESEARCH.md (patterns 1, 3, 4, 7)
@scripts/socket-manager.mjs
@scripts/state-manager.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GMInterfaceApp class</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Create ApplicationV2 class with HandlebarsApplicationMixin:

1. **DEFAULT_OPTIONS**:
   - id: 'storyframe-gm-interface'
   - classes: ['storyframe', 'gm-interface']
   - window.title: 'StoryFrame', resizable: true, icon: 'fas fa-book-open'
   - position: { width: 900, height: 600 }
   - actions: selectJournal, addSpeakerFromImage, setSpeaker, removeSpeaker, clearSpeaker

2. **PARTS**:
   - content: { template: 'modules/storyframe/templates/gm-interface.hbs', scrollable: ['.journal-content', '.speaker-gallery'] }

3. **_prepareContext(options)**:
   - Get state from game.storyframe.stateManager.getState()
   - Build journals object from game.journal (id -> name)
   - If activeJournal set, get journal, find first text page, use TextEditor.enrichHTML on content
   - Await Promise.all to resolve all speakers (call stateManager.resolveSpeaker for each)
   - Add actorDeleted: true if actorUuid present but fromUuid returns null
   - Return { journals, selectedJournal, journalContent, speakers, activeSpeaker, hasSpeakers }

4. **_onRender(context, options)**:
   - Call super._onRender
   - Call _attachResizeHandler()
   - Call _attachDragDropHandlers()

5. **_attachResizeHandler()**:
   - Get .resize-handle, .journal-pane, .split-container elements
   - mousedown on resizer: set isResizing=true, cursor=col-resize
   - document mousemove: if isResizing, calc newWidth = e.clientX - containerRect.left, enforce min 250px and max containerWidth-250px
   - document mouseup: isResizing=false, cursor=default

6. **_attachDragDropHandlers()**:
   - Get .speaker-gallery element
   - dragover: preventDefault, dropEffect=copy, add drag-over class
   - dragleave: remove drag-over class
   - drop: preventDefault, remove drag-over, use TextEditor.getDragEventData(e)
   - If data.type === 'Actor': await fromUuid(data.uuid), if actor exists call socketManager.requestAddSpeaker({ actorUuid, label })

7. **Action handlers (all static async)**:
   - _onSelectJournal: get target.value, call socketManager.requestSetActiveJournal(value || null)
   - _onAddSpeakerFromImage: new FilePicker({ type: 'image', callback: async (path) => Dialog.prompt for label, then requestAddSpeaker({ imagePath, label }) }).render(true)
   - _onSetSpeaker: get speakerId from closest [data-speaker-id], call requestSetActiveSpeaker(speakerId)
   - _onRemoveSpeaker: stopPropagation, get speakerId, Dialog.confirm, if yes call requestRemoveSpeaker(speakerId)
   - _onClearSpeaker: call requestSetActiveSpeaker(null)

**Important pitfalls to avoid:**
- Use relative icon path: 'icons/svg/mystery-man.svg' not '/icons/svg/mystery-man.svg'
- Await all fromUuid calls
- stopPropagation on remove to prevent setSpeaker bubbling
- Check game.user.isGM in render to guard (add guard or just trust it's GM-only button)
  </action>
  <verify>File exists at scripts/applications/gm-interface.mjs, exports GMInterfaceApp class</verify>
  <done>GMInterfaceApp class with all actions, drag-drop, resize handler, context preparation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into Foundry UI</name>
  <files>storyframe.mjs</files>
  <action>
Update main entry:

1. Add import: `import { GMInterfaceApp } from './scripts/applications/gm-interface.mjs';`

2. Add gmApp slot to game.storyframe namespace in init hook:
   - game.storyframe.gmApp = null

3. In ready hook, after stateManager.load():
   - Add GM-only button using Hooks.on('getSceneControlButtons')
   - If not game.user.isGM, return early
   - Create button config:
     ```javascript
     const storyframeControl = {
       name: 'storyframe',
       title: 'StoryFrame',
       icon: 'fas fa-book-open',
       visible: game.user.isGM,
       onClick: () => {
         if (!game.storyframe.gmApp) {
           game.storyframe.gmApp = new GMInterfaceApp();
         }
         game.storyframe.gmApp.render(true);
       },
       button: true
     };
     ```
   - Find token controls group: `const tokens = controls.find(c => c.name === 'token');`
   - Push button to tokens.tools array

**Note:** getSceneControlButtons hook must be registered BEFORE ready fires (in setup or init), but the onClick callback runs later when game.storyframe exists.
  </action>
  <verify>storyframe.mjs imports GMInterfaceApp; getSceneControlButtons hook adds StoryFrame button for GMs</verify>
  <done>GM can click toolbar button to open control window</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete GM interface with journal selection, speaker gallery, and all interactions</what-built>
  <how-to-verify>
1. Open Foundry v13 with StoryFrame enabled
2. Click the book icon in token controls toolbar (left side)
3. Window should open with:
   - Journal dropdown on left, speaker gallery on right
   - Resizable divider between panes
4. Select a journal from dropdown - text should appear
5. Drag an actor from Actors sidebar to gallery - should add thumbnail
6. Click thumbnail - should highlight as active
7. Click "Add from Image" - FilePicker should open, enter name, thumbnail appears
8. Click X on thumbnail - confirm dialog, removes speaker
9. Click "Clear Speaker" - active highlight should disappear
10. Close and reopen window - state should persist (same journal, speakers, active)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] GMInterfaceApp class exists with DEFAULT_OPTIONS, PARTS, _prepareContext
- [ ] All 5 action handlers implemented
- [ ] Drag-drop and resize handlers attached in _onRender
- [ ] GM button appears in token controls
- [ ] Clicking button opens window
- [ ] All 7 success criteria from roadmap work correctly
</verification>

<success_criteria>
Phase 2 complete when:
1. GM can open control window from FoundryVTT UI
2. GM can select journal from dropdown and see text content
3. GM can add speaker from actor UUID (with portrait)
4. GM can add speaker from image path (file picker)
5. GM can click thumbnail to set active speaker
6. GM can clear active speaker (narration mode)
7. Active speaker highlights in gallery immediately
</success_criteria>

<output>
After completion, create `.planning/phases/02-gm-interface/02-02-SUMMARY.md`
</output>
