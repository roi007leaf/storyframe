---
phase: 04-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - storyframe.mjs
autonomous: true

must_haves:
  truths:
    - "Ctrl+Shift+S toggles GM control window"
    - "Ctrl+Shift+S toggles player viewer for non-GM"
    - "Hotkeys configurable in Foundry settings"
  artifacts:
    - path: "storyframe.mjs"
      provides: "Keybinding registration"
      contains: "game.keybindings.register"
  key_links:
    - from: "storyframe.mjs"
      to: "game.keybindings"
      via: "init hook registration"
      pattern: "keybindings\\.register.*toggleStoryFrame"
---

<objective>
Add keyboard shortcuts to toggle StoryFrame windows.

Purpose: Power users can quickly show/hide windows without clicking toolbar.
Output: Configurable keybindings registered in Foundry settings.
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish/04-RESEARCH.md
@storyframe.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register keybindings in init hook</name>
  <files>storyframe.mjs</files>
  <action>
In the `init` hook, after settings registration, add keybinding registration:

```javascript
// Register keybindings
game.keybindings.register(MODULE_ID, 'toggleStoryFrame', {
  name: 'STORYFRAME.Keybinding.ToggleName',
  hint: 'STORYFRAME.Keybinding.ToggleHint',
  editable: [
    { key: 'KeyS', modifiers: ['Control', 'Shift'] }
  ],
  onDown: () => {
    if (game.user.isGM) {
      // Toggle GM interface
      if (!game.storyframe?.gmApp) {
        game.storyframe.gmApp = new GMInterfaceApp();
      }
      if (game.storyframe.gmApp.rendered) {
        game.storyframe.gmApp.close();
      } else {
        game.storyframe.gmApp.render(true);
      }
    } else {
      // Toggle player viewer
      if (!game.storyframe?.playerViewer) {
        game.storyframe.playerViewer = new PlayerViewerApp();
      }
      if (game.storyframe.playerViewer.rendered) {
        game.storyframe.playerViewer.close();
      } else {
        game.storyframe.playerViewer.render(true);
      }
    }
    return true; // Consume the event
  },
  restricted: false, // Available to all users
  precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL
});
```

Note: Using hardcoded strings for name/hint since localization not yet set up. Can use plain strings:
- name: 'Toggle StoryFrame'
- hint: 'Show or hide the StoryFrame window'
  </action>
  <verify>Search storyframe.mjs for `keybindings.register`</verify>
  <done>Keybinding registered with Ctrl+Shift+S default</done>
</task>

<task type="auto">
  <name>Task 2: Test keybinding in Foundry</name>
  <files>N/A - manual verification</files>
  <action>
Verification steps (document for human testing):
1. Load Foundry, check Configure Controls menu shows "Toggle StoryFrame"
2. As GM: press Ctrl+Shift+S - GM window opens
3. Press again - GM window closes
4. As Player: press Ctrl+Shift+S - player viewer opens
5. Press again - player viewer closes
6. In Configure Controls, change keybinding, verify new key works
  </action>
  <verify>Module loads without errors, keybinding appears in Configure Controls</verify>
  <done>Keybinding functional and configurable</done>
</task>

</tasks>

<verification>
1. `grep -n "keybindings.register" storyframe.mjs` shows registration
2. Foundry loads without console errors
3. Configure Controls > StoryFrame shows "Toggle StoryFrame" keybinding
4. Pressing Ctrl+Shift+S toggles appropriate window
</verification>

<success_criteria>
- Keybinding registered and appears in Foundry settings
- Default Ctrl+Shift+S works for both GM and players
- Users can rebind to different key combination
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-02-SUMMARY.md`
</output>
