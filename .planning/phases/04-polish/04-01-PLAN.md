---
phase: 04-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/applications/gm-interface.mjs
  - scripts/applications/player-viewer.mjs
  - storyframe.mjs
autonomous: true

must_haves:
  truths:
    - "Window position restored within visible screen bounds after monitor change"
    - "Minimized state restores when reopening window"
    - "GM control window auto-opens on reconnect if was open before"
    - "Journal dropdown shows previously selected journal on reconnect"
    - "Active speaker highlight restores on reconnect"
    - "Speaker list loads from flags on page reload"
  artifacts:
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Position validation, minimized state save/restore, state restoration from flags"
      contains: "validatePosition"
    - path: "scripts/applications/player-viewer.mjs"
      provides: "Position validation, minimized state save/restore"
      contains: "validatePosition"
    - path: "storyframe.mjs"
      provides: "Settings for minimized state, auto-open logic"
      contains: "gmWindowMinimized"
  key_links:
    - from: "scripts/applications/gm-interface.mjs"
      to: "game.settings"
      via: "constructor position load"
      pattern: "validatePosition.*savedPosition"
    - from: "scripts/applications/gm-interface.mjs"
      to: "stateManager.getState()"
      via: "_onRender restore"
      pattern: "activeJournal.*getState"
---

<objective>
Add window state persistence refinements: off-screen position validation, minimized state memory, and data restoration from StateManager flags.

Purpose: Windows restore correctly after monitor changes, remember minimized state, and journal/speaker selection persists across reconnects.
Output: Both GM and player windows validate positions, persist minimized state, and GM interface restores journal/speaker selection from flags.
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish/04-RESEARCH.md
@scripts/applications/gm-interface.mjs
@scripts/applications/player-viewer.mjs
@scripts/state-manager.mjs
@storyframe.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add position validation helper and minimized state settings</name>
  <files>storyframe.mjs</files>
  <action>
1. Add helper function `validatePosition(saved)` that clamps position to visible screen:
   - `top`: clamp to [0, window.innerHeight - 50]
   - `left`: clamp to [0, window.innerWidth - 100]
   - `width`: clamp to [200, window.innerWidth]
   - `height`: clamp to [150, window.innerHeight]
   - Export function for use in app constructors

2. Register two new client settings:
   - `gmWindowMinimized` (Boolean, default false) - GM window minimized state
   - `playerViewerMinimized` (Boolean, default false) - player viewer minimized state

3. Register one new client setting:
   - `gmWindowWasOpen` (Boolean, default false) - track if GM window was open (for reconnect auto-open)

4. In `ready` hook, after stateManager.load(), add GM auto-open logic:
   - If `game.user.isGM` and `game.settings.get(MODULE_ID, 'gmWindowWasOpen')` is true
   - Create `game.storyframe.gmApp = new GMInterfaceApp()` and `.render(true)`
   - The GM interface will restore journal/speaker state from stateManager in _onRender
  </action>
  <verify>Search storyframe.mjs for: `validatePosition`, `gmWindowMinimized`, `gmWindowWasOpen`</verify>
  <done>Helper function and settings registered, GM auto-open on reconnect works</done>
</task>

<task type="auto">
  <name>Task 2: Integrate position validation, minimized state, and data restoration in GM interface</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
1. Import validatePosition from storyframe.mjs (or inline if import issues)

2. In constructor, wrap position restore with validation:
   ```javascript
   const saved = game.settings.get(MODULE_ID, 'gmWindowPosition');
   if (saved && Object.keys(saved).length > 0) {
     this.position = { ...this.position, ...validatePosition(saved) };
   }
   ```

3. Add `_onRender` logic to restore state (first render only):
   - Add instance property `this._stateRestored = false` in constructor
   - In `_onRender`, if `!this._stateRestored`:
     a. Get `gmWindowMinimized` setting - if true, call `this.minimize()`
     b. **Restore journal selection from StateManager flags:**
        - Get `activeJournal` from `game.storyframe.stateManager.getState()`
        - If activeJournal exists, set dropdown value and trigger journal load
        - This ensures journal dropdown shows previously selected journal
     c. **Active speaker already in flags** - StateManager.getState().activeSpeaker
        - Gallery render already uses this, so highlight restores automatically
     d. Set `this._stateRestored = true`

4. Update `_onClose` to save minimized state:
   - Save `game.settings.set(MODULE_ID, 'gmWindowMinimized', this.minimized)`
   - Save `game.settings.set(MODULE_ID, 'gmWindowWasOpen', false)` (closing means not open)

5. Add tracking for "was open" state - save `gmWindowWasOpen: true` when window renders:
   - In `_onRender`, set `game.settings.set(MODULE_ID, 'gmWindowWasOpen', true)`
  </action>
  <verify>Open GM window, select journal, add speakers, set active speaker, close browser, reopen Foundry - window auto-opens with same journal selected and active speaker highlighted</verify>
  <done>GM window validates position, persists minimized state, restores journal selection from flags, active speaker highlight restores</done>
</task>

<task type="auto">
  <name>Task 3: Integrate position validation and minimized state in player viewer</name>
  <files>scripts/applications/player-viewer.mjs</files>
  <action>
1. Add validatePosition helper (inline or import)

2. In constructor, wrap position restore with validation:
   ```javascript
   const saved = game.settings.get(MODULE_ID, 'playerViewerPosition');
   if (saved && Object.keys(saved).length > 0) {
     this.position = { ...this.position, ...validatePosition(saved) };
   }
   ```

3. Add `_onRender` logic to restore minimized state (first render only):
   - Add `this._stateRestored = false` in constructor
   - In `_onRender`, if `!this._stateRestored`:
     - Get `playerViewerMinimized` setting
     - If true, call `this.minimize()`
     - Set `this._stateRestored = true`

4. Update `_onClose` to save minimized state:
   - Save `game.settings.set(MODULE_ID, 'playerViewerMinimized', this.minimized)`
  </action>
  <verify>Open player viewer, minimize, close, reload - should restore minimized</verify>
  <done>Player viewer validates position and persists minimized state</done>
</task>

</tasks>

<verification>
1. Move GM window off-screen (via dev tools), save position, reload - window appears on-screen
2. Minimize GM window, close it, reload Foundry - window opens minimized
3. Open GM window, close browser, reconnect - GM window auto-opens
4. **NEW:** Select journal in GM window, add speakers, set active speaker, reload Foundry - journal dropdown shows same journal, active speaker highlighted
5. **NEW:** Speaker list persists - add speakers, reload page, open GM window - speakers still in gallery (from StateManager flags)
6. Same position/minimized tests for player viewer
</verification>

<success_criteria>
- Windows clamp to visible screen on restore
- Minimized state persists across sessions
- GM window auto-opens on reconnect if was open before
- Journal selection restores from StateManager flags on reconnect
- Active speaker highlight restores from StateManager flags on reconnect
- Speaker list persists across Foundry restarts (from StateManager flags)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-01-SUMMARY.md`
</output>
