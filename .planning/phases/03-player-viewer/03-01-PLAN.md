---
phase: 03-player-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/applications/player-viewer.mjs
  - templates/player-viewer.hbs
  - styles/player-viewer.css
  - storyframe.mjs
  - module.json
autonomous: true

must_haves:
  truths:
    - "Player can open viewer window"
    - "Viewer shows current speaker portrait and name"
    - "Viewer updates automatically when GM changes speaker"
    - "Viewer closes when GM clears speaker (narration)"
    - "Viewer is read-only (no edit controls)"
    - "Deleted actors show fallback icon"
  artifacts:
    - path: "scripts/applications/player-viewer.mjs"
      provides: "PlayerViewerApp ApplicationV2 class"
      contains: "class PlayerViewerApp"
    - path: "templates/player-viewer.hbs"
      provides: "Player viewer template"
      contains: "speaker-display"
    - path: "styles/player-viewer.css"
      provides: "Player viewer styling"
      contains: ".player-viewer"
  key_links:
    - from: "storyframe.mjs"
      to: "PlayerViewerApp"
      via: "import and initialization"
      pattern: "import.*PlayerViewerApp"
    - from: "storyframe.mjs"
      to: "updateScene hook"
      via: "Hooks.on('updateScene')"
      pattern: "Hooks\\.on\\('updateScene'"
    - from: "scripts/applications/player-viewer.mjs"
      to: "StateManager"
      via: "_prepareContext uses getState()"
      pattern: "game\\.storyframe\\.stateManager\\.getState"
---

<objective>
Create PlayerViewerApp for players to see current speaker portrait and name with real-time updates.

Purpose: Complete the GM-to-player broadcast loop - GM sets speaker, players see it instantly.
Output: Working player viewer window with automatic show/hide based on active speaker state.
</objective>

<execution_context>
@/Users/roihorowitz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roihorowitz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-viewer/03-RESEARCH.md
@scripts/applications/gm-interface.mjs
@storyframe.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerViewerApp class with template and CSS</name>
  <files>
    scripts/applications/player-viewer.mjs
    templates/player-viewer.hbs
    styles/player-viewer.css
  </files>
  <action>
Create PlayerViewerApp extending HandlebarsApplicationMixin(ApplicationV2).

**player-viewer.mjs:**
- DEFAULT_OPTIONS: id 'storyframe-player-viewer', classes ['storyframe', 'player-viewer'], window title 'StoryFrame - Current Speaker', resizable true, minimizable true, icon 'fas fa-user', position 300x400
- PARTS: single 'content' template at 'modules/storyframe/templates/player-viewer.hbs'
- _prepareContext: get state from stateManager, return noSpeaker:true if no activeSpeaker or speaker not found, else return speaker {img, name} resolved via _resolveSpeaker helper
- _resolveSpeaker(speaker): if actorUuid → fromUuid → return actor.img/name or fallback to imagePath/label/mystery-man.svg if actor deleted; if just imagePath → return it with label

**player-viewer.hbs:**
- speaker-display container
- if noSpeaker: show "No speaker active" with hint "Waiting for GM..."
- else: speaker-portrait div with img, speaker-info div with h2 name

**player-viewer.css:**
- .speaker-display: flex column, center items, full height, 1rem padding
- .speaker-portrait: flex-grow, centered, full width
- .speaker-portrait img: max-width/height 100%, object-fit contain, rounded corners, shadow
- .speaker-info: centered text, margin-top 1rem, h2 margin 0 font-size 1.5rem
- .no-speaker: centered, muted color

Follow Pattern 1 and Pattern 4 from 03-RESEARCH.md exactly.
  </action>
  <verify>
Files exist at correct paths. Class extends HandlebarsApplicationMixin(ApplicationV2). Template has noSpeaker conditional. CSS has player-viewer selectors.
  </verify>
  <done>
PlayerViewerApp class created with template and CSS, ready for integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire hooks for real-time updates and add player button</name>
  <files>
    storyframe.mjs
    module.json
  </files>
  <action>
**storyframe.mjs changes:**

1. Add import: `import { PlayerViewerApp } from './scripts/applications/player-viewer.mjs';`

2. Register client setting for player viewer position in init hook:
```javascript
game.settings.register(MODULE_ID, 'playerViewerPosition', {
  scope: 'client',
  config: false,
  type: Object,
  default: {}
});
```

3. In ready hook, after existing GM check, add player initialization:
```javascript
if (!game.user.isGM) {
  game.storyframe.playerViewer = new PlayerViewerApp();
  // Auto-open if activeSpeaker already set
  const state = game.storyframe.stateManager.getState();
  if (state?.activeSpeaker) {
    game.storyframe.playerViewer.render(true);
  }
}
```

4. Add updateScene hook listener (new hook, not inside ready):
```javascript
Hooks.on('updateScene', async (scene, changed, options, userId) => {
  // Only current scene
  if (scene.id !== game.scenes.current?.id) return;
  // Only storyframe flags
  if (!changed.flags?.storyframe) return;

  console.log(`${MODULE_ID} | Scene flags updated`);

  // Reload state
  await game.storyframe.stateManager.load();
  const state = game.storyframe.stateManager.getState();

  // Update GM interface if open
  if (game.user.isGM && game.storyframe.gmApp?.rendered) {
    game.storyframe.gmApp.render();
  }

  // Update player viewer
  if (!game.user.isGM) {
    const viewer = game.storyframe.playerViewer;
    if (state?.activeSpeaker && !viewer.rendered) {
      viewer.render(true);  // Auto-open
    } else if (!state?.activeSpeaker && viewer.rendered) {
      viewer.close();  // Auto-close
    } else if (viewer.rendered) {
      viewer.render();  // Update display
    }
  }
});
```

5. In getSceneControlButtons hook, add player button (outside the isGM check):
After the GM-only block, add:
```javascript
// Player button (non-GM only)
if (!game.user.isGM && controls.tokens) {
  controls.tokens.tools.storyframe = {
    name: 'storyframe',
    title: 'StoryFrame Viewer',
    icon: 'fas fa-user',
    visible: true,
    onClick: () => {
      if (!game.storyframe?.playerViewer) {
        game.storyframe.playerViewer = new PlayerViewerApp();
      }
      game.storyframe.playerViewer.render(true);
    },
    button: true
  };
}
```

**module.json:**
Add 'styles/player-viewer.css' to the styles array.

Follow Pattern 2, Pattern 3 from 03-RESEARCH.md. Key pitfalls to avoid:
- Filter updateScene to current scene only (scene.id !== game.scenes.current?.id)
- Check viewer.rendered before render() calls
- Auto-close when activeSpeaker is null
  </action>
  <verify>
1. Foundry loads without errors
2. Player sees StoryFrame button in token controls
3. GM changing speaker triggers updateScene hook (check console)
4. Player viewer auto-opens when speaker set, auto-closes when cleared
  </verify>
  <done>
Player viewer fully integrated with real-time updates via updateScene hook.
  </done>
</task>

</tasks>

<verification>
1. As GM: Open GM interface, select journal, add speaker, set active speaker
2. As Player (second browser/incognito): Viewer auto-opens showing speaker portrait + name
3. As GM: Change active speaker → Player viewer updates immediately
4. As GM: Clear speaker (narration mode) → Player viewer auto-closes
5. As Player: Click StoryFrame button → Viewer opens (manual open)
6. As GM: Delete actor that's a speaker → Player viewer shows mystery-man fallback
7. Verify no edit controls visible in player viewer (read-only)
</verification>

<success_criteria>
- PLAY-01: Player can open viewer window via button in token controls
- PLAY-02: Viewer shows current speaker portrait (img tag with resolved path)
- PLAY-03: Viewer shows current speaker name (h2 element)
- PLAY-04: Viewer updates in real-time via updateScene hook
- PLAY-05: Viewer is read-only (template has no form inputs or buttons)
- PLAY-06: Viewer auto-closes when activeSpeaker is null
- PLAY-07: Deleted actors fall back to mystery-man.svg
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-viewer/03-01-SUMMARY.md`
</output>
