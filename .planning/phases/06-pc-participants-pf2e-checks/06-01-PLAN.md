---
phase: 06-pc-participants-pf2e-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/state-manager.mjs
  - scripts/socket-manager.mjs
  - storyframe.mjs
autonomous: true

must_haves:
  truths:
    - "Participant list persists across page reload"
    - "Roll requests survive scene reload within same scene"
    - "Roll history accumulates completed rolls during scene"
    - "Adding a participant from any client updates all clients"
    - "Roll request sent by GM reaches target player's client"
  artifacts:
    - path: "scripts/state-manager.mjs"
      provides: "Extended state schema with participants, pendingRolls, rollHistory"
      contains: "participants:"
    - path: "scripts/socket-manager.mjs"
      provides: "Socket handlers for participant and roll operations"
      contains: "addParticipant"
    - path: "storyframe.mjs"
      provides: "Scene change hook for clearing pending rolls"
      contains: "canvasReady"
  key_links:
    - from: "scripts/socket-manager.mjs"
      to: "scripts/state-manager.mjs"
      via: "requestAddParticipant calls stateManager.addParticipant"
      pattern: "stateManager\\.addParticipant"
    - from: "scripts/socket-manager.mjs"
      to: "scripts/applications/player-viewer.mjs"
      via: "_handlePromptSkillCheck calls playerApp.showRollPrompt"
      pattern: "playerApp\\.showRollPrompt"
---

<objective>
Extend StateManager and SocketManager to support PC participants and skill check requests.

Purpose: Foundation layer for participant management and roll request/result flow
Output: Extended state schema persisting to scene flags, socket handlers for all participant and roll operations
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-pc-participants-pf2e-checks/06-RESEARCH.md
@scripts/state-manager.mjs
@scripts/socket-manager.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend StateManager schema with participants and roll tracking</name>
  <files>scripts/state-manager.mjs</files>
  <action>
Extend the state schema in StateManager to support participants and roll tracking:

1. Update _createDefaultState() to include:
   - participants: [] (array of {id, actorUuid, userId})
   - pendingRolls: [] (array of {id, participantId, skillSlug, dc: {value, visibility}, timestamp})
   - rollHistory: [] (array of {requestId, participantId, skillSlug, total, degreeOfSuccess, timestamp, chatMessageId})

2. Add CRUD methods for participants:
   - addParticipant({actorUuid, userId}) - creates participant with randomID, persists to flags
   - removeParticipant(participantId) - removes from array, clears their pending rolls
   - clearAllParticipants() - empties array

3. Add methods for roll tracking:
   - addPendingRoll(rollRequest) - adds to pendingRolls array
   - removePendingRoll(requestId) - removes from pendingRolls
   - clearPendingRollsForParticipant(participantId) - removes all pending for one participant
   - addRollResult(result) - adds to rollHistory, enforces 50-item limit (FIFO)
   - clearRollHistory() - empties rollHistory (for scene change hook)
   - clearPendingRolls() - empties pendingRolls array (for scene change hook)

4. Increment SCHEMA_VERSION to 2 and add migration in _migrate():
   - If version 1: add participants: [], pendingRolls: [], rollHistory: []

All methods should call _broadcast() after state changes.
  </action>
  <verify>
In browser console:
- `game.storyframe.stateManager.getState()` shows participants, pendingRolls, rollHistory arrays
- `await game.storyframe.stateManager.addParticipant({actorUuid: 'test', userId: 'test'})` returns participant object with id
- State persists after page reload (check scene flags)
  </verify>
  <done>StateManager has full participant and roll tracking API, schema version 2</done>
</task>

<task type="auto">
  <name>Task 2: Extend SocketManager with participant and roll handlers</name>
  <files>scripts/socket-manager.mjs</files>
  <action>
Add socket handlers for participant and roll operations:

1. Register new handlers in constructor:
   - 'addParticipant' (executeAsGM)
   - 'removeParticipant' (executeAsGM)
   - 'clearAllParticipants' (executeAsGM)
   - 'addPendingRoll' (executeAsGM)
   - 'removePendingRoll' (executeAsGM)
   - 'submitRollResult' (executeAsGM)
   - 'promptSkillCheck' (for executeAsUser - runs on target player)
   - 'rollHistoryUpdate' (executeForEveryone - sync results)

2. Add public API methods:
   - requestAddParticipant(participantData) - calls executeAsGM('addParticipant', ...)
   - requestRemoveParticipant(participantId)
   - requestClearAllParticipants()
   - requestAddPendingRoll(rollRequest)
   - requestRemovePendingRoll(requestId)
   - requestSubmitRollResult(result)
   - triggerSkillCheckOnPlayer(userId, requestData) - calls executeAsUser('promptSkillCheck', userId, ...)
   - broadcastRollHistoryUpdate(historyData) - calls executeForEveryone('rollHistoryUpdate', ...)

3. Add handler implementations:
   - _handleAddParticipant(data) - calls stateManager.addParticipant(data)
   - _handleRemoveParticipant(id) - calls stateManager.removeParticipant(id)
   - _handleClearAllParticipants() - calls stateManager.clearAllParticipants()
   - _handleAddPendingRoll(request) - calls stateManager.addPendingRoll(request)
   - _handleRemovePendingRoll(id) - calls stateManager.removePendingRoll(id)
   - _handleSubmitRollResult(result) - calls stateManager.addRollResult(result), removes pending roll
   - _handlePromptSkillCheck(requestData) - **CRITICAL: This runs on PLAYER client. Must call `game.storyframe.playerApp.showRollPrompt(requestData)` to trigger the player viewer to display the roll prompt.**
   - _handleRollHistoryUpdate(data) - updates local roll history display

The key wiring for roll prompts:
- GM calls `triggerSkillCheckOnPlayer(userId, requestData)`
- socketlib routes to player's client via executeAsUser
- Player's `_handlePromptSkillCheck` receives the call
- Handler calls `game.storyframe.playerApp.showRollPrompt(requestData)` to update UI
  </action>
  <verify>
In browser console:
- SocketManager has all new methods: `Object.keys(game.storyframe.socketManager).filter(k => k.includes('Participant') || k.includes('Roll'))`
- GM client: `await game.storyframe.socketManager.requestAddParticipant({actorUuid: 'test', userId: game.user.id})` succeeds
- State shows participant after socket call
  </verify>
  <done>SocketManager has complete participant and roll socket API with executeAsUser support</done>
</task>

<task type="auto">
  <name>Task 3: Add scene change hook to clear pending rolls</name>
  <files>scripts/state-manager.mjs, storyframe.mjs</files>
  <action>
Add cleanup logic for scene changes to prevent stale roll requests:

1. In storyframe.mjs (main entry), register canvasReady hook:
   ```javascript
   Hooks.on('canvasReady', () => {
     // Clear pending rolls on scene change
     if (game.user.isGM && game.storyframe.stateManager) {
       game.storyframe.stateManager.clearPendingRolls();
     }
   });
   ```

2. Add clearPendingRolls() method to StateManager (if not already added in Task 1):
   - Empties pendingRolls array
   - Does NOT clear rollHistory (that persists within scene)
   - Calls _broadcast()

This ensures players don't see stale roll prompts from previous scenes.
  </action>
  <verify>
- Switch scenes in Foundry
- Check `game.storyframe.stateManager.getState().pendingRolls` is empty after scene change
- rollHistory is preserved within same scene
  </verify>
  <done>Scene changes automatically clear pending roll requests</done>
</task>

</tasks>

<verification>
1. Schema version is 2: `game.storyframe.stateManager.getState().version === 2`
2. All arrays exist: participants, pendingRolls, rollHistory in state
3. Socket handlers registered: Check console for initialization messages
4. State persists: Reload page, verify state restored from scene flags
5. Scene change clears pending: Switch scenes, verify pendingRolls empty
</verification>

<success_criteria>
- StateManager schema includes participants, pendingRolls, rollHistory arrays
- All CRUD methods work for participants and rolls
- Socket handlers connect UI actions to state changes
- executeAsUser available for targeting player clients
- _handlePromptSkillCheck calls playerApp.showRollPrompt to trigger UI update
- Scene change cleanup prevents stale requests
</success_criteria>

<output>
After completion, create `.planning/phases/06-pc-participants-pf2e-checks/06-01-SUMMARY.md`
</output>
