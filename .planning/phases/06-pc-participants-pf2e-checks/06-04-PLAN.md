---
phase: 06-pc-participants-pf2e-checks
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - scripts/applications/gm-interface.mjs
  - templates/gm-interface.hbs
  - styles/gm-interface.css
  - storyframe.mjs
autonomous: false

must_haves:
  truths:
    - "GM can see collapsible roll history panel showing past rolls this scene"
    - "Roll history shows participant name, skill, result, and degree of success"
    - "GM can cancel pending roll requests"
    - "Roll history clears on scene change"
    - "Quick button skill selection can be configured via module settings"
  artifacts:
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Roll history panel rendering and cancel functionality"
      contains: "rollHistory"
    - path: "templates/gm-interface.hbs"
      provides: "Roll history panel HTML"
      contains: "roll-history"
    - path: "storyframe.mjs"
      provides: "Module setting for quick button configuration"
      contains: "quickButtonSkills"
  key_links:
    - from: "scripts/applications/gm-interface.mjs"
      to: "state.rollHistory"
      via: "Reads roll history from state"
      pattern: "state\\.rollHistory"
    - from: "storyframe.mjs"
      to: "quickButtonSkills setting"
      via: "Module settings registration"
      pattern: "registerSetting.*quickButtonSkills"
---

<objective>
Add roll history panel, cancel functionality, and quick button configuration to complete the feature.

Purpose: GM can track roll results, cancel pending requests, and customize quick buttons
Output: Roll history panel, cancel buttons, module setting for quick skills
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-pc-participants-pf2e-checks/06-CONTEXT.md
@.planning/phases/06-pc-participants-pf2e-checks/06-RESEARCH.md
@.planning/phases/06-pc-participants-pf2e-checks/06-01-SUMMARY.md
@.planning/phases/06-pc-participants-pf2e-checks/06-02-SUMMARY.md
@.planning/phases/06-pc-participants-pf2e-checks/06-03-SUMMARY.md
@scripts/applications/gm-interface.mjs
@templates/gm-interface.hbs
@storyframe.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add roll history panel to GM interface</name>
  <files>templates/gm-interface.hbs, scripts/applications/gm-interface.mjs, styles/gm-interface.css</files>
  <action>
Add a collapsible roll history panel to the GM interface showing completed rolls:

**Template (gm-interface.hbs):**
Add after participants panel:
```handlebars
<!-- Roll History Panel -->
<div class="roll-history-panel {{#if rollHistoryCollapsed}}collapsed{{/if}}">
  <div class="panel-header" data-action="toggleRollHistoryPanel">
    <h3>Roll History</h3>
    <span class="history-count">{{rollHistory.length}}</span>
    <i class="fas {{#if rollHistoryCollapsed}}fa-chevron-down{{else}}fa-chevron-up{{/if}}"></i>
  </div>

  <div class="panel-content">
    {{#if rollHistory.length}}
      <div class="history-list">
        {{#each rollHistory}}
          <div class="history-item degree-{{this.degreeClass}}">
            <div class="roll-info">
              <span class="participant-name">{{this.participantName}}</span>
              <span class="skill-name">{{this.skillName}}</span>
            </div>
            <div class="roll-result">
              <span class="roll-total">{{this.total}}</span>
              <span class="degree-badge">{{this.degreeText}}</span>
            </div>
          </div>
        {{/each}}
      </div>
      <button type="button" data-action="clearRollHistory" class="clear-history-btn">
        <i class="fas fa-trash"></i> Clear History
      </button>
    {{else}}
      <div class="empty-state">
        <p>No rolls yet</p>
      </div>
    {{/if}}
  </div>
</div>

<!-- Pending Rolls with Cancel -->
{{#if pendingRolls.length}}
<div class="pending-rolls-panel">
  <h4>Pending Requests</h4>
  {{#each pendingRolls}}
    <div class="pending-item">
      <span class="participant-name">{{this.participantName}}</span>
      <span class="skill-name">{{this.skillName}}</span>
      <button type="button" data-action="cancelRoll" data-request-id="{{this.id}}" title="Cancel">
        <i class="fas fa-times"></i>
      </button>
    </div>
  {{/each}}
</div>
{{/if}}
```

**GMInterfaceApp (gm-interface.mjs):**
1. Add to constructor:
   - this.rollHistoryCollapsed = false

2. Add to DEFAULT_OPTIONS.actions:
   - toggleRollHistoryPanel: GMInterfaceApp._onToggleRollHistoryPanel
   - clearRollHistory: GMInterfaceApp._onClearRollHistory
   - cancelRoll: GMInterfaceApp._onCancelRoll

3. Update _prepareContext to include:
   ```javascript
   // Roll history with resolved names and degree formatting
   const rollHistory = (state.rollHistory || []).map(r => {
     const participant = state.participants?.find(p => p.id === r.participantId);
     return {
       ...r,
       participantName: participant ? this._resolveParticipantName(participant) : 'Unknown',
       skillName: this._getSkillName(r.skillSlug),
       degreeClass: this._getDegreeClass(r.degreeOfSuccess),
       degreeText: this._getDegreeText(r.degreeOfSuccess)
     };
   }).reverse(); // Most recent first

   // Pending rolls with names
   const pendingRolls = (state.pendingRolls || []).map(r => {
     const participant = state.participants?.find(p => p.id === r.participantId);
     return {
       ...r,
       participantName: participant ? this._resolveParticipantName(participant) : 'Unknown',
       skillName: this._getSkillName(r.skillSlug)
     };
   });
   ```

4. Add helper methods:
   ```javascript
   _getDegreeClass(degree) {
     switch(degree) {
       case 2: return 'critical-success';
       case 1: return 'success';
       case 0: return 'failure';
       case -1: return 'critical-failure';
       default: return 'unknown';
     }
   }

   _getDegreeText(degree) {
     switch(degree) {
       case 2: return 'Crit Success';
       case 1: return 'Success';
       case 0: return 'Failure';
       case -1: return 'Crit Fail';
       default: return '?';
     }
   }

   async _resolveParticipantName(participant) {
     const actor = await fromUuid(participant.actorUuid);
     return actor?.name || 'Unknown';
   }
   ```

5. Implement action handlers:
   - _onToggleRollHistoryPanel: toggle collapsed state
   - _onClearRollHistory: call stateManager.clearRollHistory()
   - _onCancelRoll: call socketManager.requestRemovePendingRoll(requestId)

**CSS (gm-interface.css):**
Add styling for roll history and pending rolls panels (similar to participants panel styling).
Include degree-of-success color coding:
- critical-success: green
- success: light green
- failure: orange
- critical-failure: red
  </action>
  <verify>
- Roll history panel visible in GM interface
- After player completes roll, result appears in history
- History shows participant, skill, total, degree of success
- Cancel button removes pending roll
- Clear History button empties roll history
  </verify>
  <done>Roll history panel displays completed rolls with degree of success coloring</done>
</task>

<task type="auto">
  <name>Task 2: Add quick button configuration setting</name>
  <files>storyframe.mjs</files>
  <action>
Add a module setting for configuring which skills appear as quick buttons:

1. In the settings registration (init hook), add:
   ```javascript
   game.settings.register(MODULE_ID, 'quickButtonSkills', {
     name: 'Quick Button Skills',
     hint: 'Comma-separated skill slugs for quick buttons (e.g., per,dec,dip,itm,prf)',
     scope: 'world',
     config: true,
     type: String,
     default: 'per,dec,dip,itm,prf',
     onChange: () => {
       // Re-render GM interface if open
       game.storyframe.gmApp?.render();
     }
   });
   ```

2. Update GMInterfaceApp._prepareContext to read this setting:
   ```javascript
   const quickSkillsSetting = game.settings.get(MODULE_ID, 'quickButtonSkills');
   const quickSkills = quickSkillsSetting.split(',').map(s => s.trim()).filter(Boolean);

   // Map to display data
   const quickButtonSkills = quickSkills.map(slug => ({
     slug,
     name: this._getSkillName(slug),
     shortName: this._getSkillShortName(slug)
   }));
   ```

3. Add _getSkillShortName helper for button labels:
   ```javascript
   _getSkillShortName(slug) {
     const shortNames = {
       per: 'Per', acr: 'Acr', arc: 'Arc', ath: 'Ath', cra: 'Cra',
       dec: 'Dec', dip: 'Dip', itm: 'Itm', med: 'Med', nat: 'Nat',
       occ: 'Occ', prf: 'Prf', rel: 'Rel', soc: 'Soc', ste: 'Ste',
       sur: 'Sur', thi: 'Thi'
     };
     return shortNames[slug] || slug.substring(0, 3);
   }
   ```

4. Update template to use dynamic quick buttons:
   ```handlebars
   <div class="quick-skills">
     {{#each quickButtonSkills}}
       <button type="button" data-action="requestSkill" data-skill="{{this.slug}}" title="{{this.name}}">
         {{#if (eq this.slug 'per')}}<i class="fas fa-eye"></i>{{/if}}
         {{this.shortName}}
       </button>
     {{/each}}
     <button type="button" data-action="openSkillMenu" title="More skills...">
       <i class="fas fa-ellipsis-h"></i>
     </button>
   </div>
   ```
  </action>
  <verify>
- Module settings shows "Quick Button Skills" option
- Changing setting updates quick buttons in GM interface
- Default shows Per, Dec, Dip, Itm, Prf
- Adding new slugs (e.g., ath,ste) shows those buttons
  </verify>
  <done>Quick button skills configurable via module settings</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete PC Participants and PF2e Check Rolls feature</what-built>
  <how-to-verify>
**Test the full workflow (requires GM and Player clients):**

1. **Setup:**
   - Open Foundry with GM account
   - Open second browser/tab with a player account
   - Both should have StoryFrame viewer open

2. **Participant Management (GM):**
   - In GM interface, expand Participants panel
   - Click "Add All PCs" - verify all player characters appear
   - Try dragging a PC actor from sidebar to participant list
   - Remove a participant, verify it disappears

3. **Request Check (GM):**
   - Select one or more participants (click to highlight)
   - Click a quick skill button (e.g., Diplomacy)
   - Verify notification shows "Requested Diplomacy check from X participant(s)"
   - Set DC to 25 using preset button, request another check
   - Use custom DC input, verify it works

4. **Player Roll (Player client):**
   - Verify roll prompt appears in player's StoryFrame viewer
   - Prompt shows skill name only (no DC visible)
   - Click Roll button
   - Verify PF2e modifier dialog opens
   - Complete the roll
   - Verify chat card appears with roll result
   - Verify prompt disappears from viewer

5. **Roll History (GM):**
   - After player completes roll, verify result appears in roll history
   - Check degree of success color coding (green for success, red for crit fail, etc.)
   - Try canceling a pending roll, verify it disappears from pending and player prompt

6. **Settings:**
   - Go to Module Settings, find "Quick Button Skills"
   - Change to different skills (e.g., "per,ath,ste,sur")
   - Verify quick buttons update in GM interface

7. **Edge Cases:**
   - Request check from participant, then remove them before they roll
   - Request check with no participants selected (should warn)
   - Scene change clears pending rolls
  </how-to-verify>
  <resume-signal>Type "approved" if the feature works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Roll history panel shows completed rolls with participant, skill, total, degree
2. Degree of success has color coding (crit success green, crit fail red)
3. Cancel button removes pending rolls from state and player viewer
4. Clear History button empties roll history
5. Quick button skills configurable via module settings
6. Settings changes reflect immediately in GM interface
7. Full workflow: GM requests -> Player sees prompt -> Player rolls -> GM sees result
</verification>

<success_criteria>
- Roll history provides GM visibility into completed checks
- Cancel functionality allows GM to retract pending requests
- Quick buttons configurable for different playstyles
- Complete end-to-end flow works across GM and player clients
- Feature feels integrated and polished
</success_criteria>

<output>
After completion, create `.planning/phases/06-pc-participants-pf2e-checks/06-04-SUMMARY.md`
</output>
