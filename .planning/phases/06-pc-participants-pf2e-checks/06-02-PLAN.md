---
phase: 06-pc-participants-pf2e-checks
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/applications/gm-interface.mjs
  - templates/gm-interface.hbs
  - styles/gm-interface.css
autonomous: true

must_haves:
  truths:
    - "GM can see collapsible Participants panel in GM interface"
    - "GM can add PC actors to participants via drag-drop or Add All PCs button"
    - "GM can remove individual participants from the panel"
    - "GM can select participant(s) and choose a skill to request"
    - "GM can set DC value (preset buttons or custom) before requesting"
    - "GM can choose whether DC is visible to players or hidden"
    - "Skill quick buttons show social skills plus Perception by default"
  artifacts:
    - path: "scripts/applications/gm-interface.mjs"
      provides: "Participant panel logic, skill request actions"
      contains: "addParticipant"
    - path: "templates/gm-interface.hbs"
      provides: "Participants panel HTML, skill buttons, DC input, DC visibility toggle"
      contains: "participants-panel"
    - path: "styles/gm-interface.css"
      provides: "Styling for participant panel and skill request UI"
      contains: ".participants-panel"
  key_links:
    - from: "scripts/applications/gm-interface.mjs"
      to: "scripts/socket-manager.mjs"
      via: "requestAddParticipant socket call"
      pattern: "socketManager\\.requestAddParticipant"
    - from: "scripts/applications/gm-interface.mjs"
      to: "scripts/socket-manager.mjs"
      via: "triggerSkillCheckOnPlayer socket call"
      pattern: "socketManager\\.triggerSkillCheckOnPlayer"
---

<objective>
Add participant management panel and skill check request UI to GM interface.

Purpose: GM can define which PCs are in the conversation and request skill checks from them
Output: Collapsible participants panel with add/remove, skill quick buttons, DC input with visibility control
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-pc-participants-pf2e-checks/06-CONTEXT.md
@.planning/phases/06-pc-participants-pf2e-checks/06-RESEARCH.md
@.planning/phases/06-pc-participants-pf2e-checks/06-01-SUMMARY.md
@scripts/applications/gm-interface.mjs
@templates/gm-interface.hbs
@styles/gm-interface.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add participants panel to GM interface template</name>
  <files>templates/gm-interface.hbs</files>
  <action>
Add a collapsible participants panel below the speakers sidebar in the GM interface:

1. Add panel structure after speakers-sidebar closing div, still within three-column-layout:
   ```handlebars
   <!-- Participants Panel (collapsible, separate from speakers) -->
   <div class="participants-panel {{#if participantsPanelCollapsed}}collapsed{{/if}}">
     <div class="panel-header" data-action="toggleParticipantsPanel">
       <h3>Participants</h3>
       <i class="fas {{#if participantsPanelCollapsed}}fa-chevron-down{{else}}fa-chevron-up{{/if}}"></i>
     </div>

     <div class="panel-content">
       <div class="participant-actions">
         <button type="button" data-action="addAllPCs" title="Add all player characters">
           <i class="fas fa-users"></i> Add All PCs
         </button>
       </div>

       <div class="participant-list" data-drop-zone="participant">
         {{#if hasParticipants}}
           {{#each participants}}
             <div class="participant-item {{#if this.selected}}selected{{/if}}"
                  data-action="toggleParticipantSelection"
                  data-participant-id="{{this.id}}">
               <img src="{{this.img}}" alt="{{this.name}}">
               <span class="participant-name">{{this.name}}</span>
               <button type="button" class="remove-participant"
                       data-action="removeParticipant"
                       data-participant-id="{{this.id}}"
                       title="Remove">
                 <i class="fas fa-times"></i>
               </button>
             </div>
           {{/each}}
         {{else}}
           <div class="empty-state">
             <p>No participants</p>
             <p>Drag PC actors here or Add All PCs</p>
           </div>
         {{/if}}
       </div>

       <!-- Skill Check Request Section -->
       <div class="skill-request-section">
         <div class="quick-skills">
           <button type="button" data-action="requestSkill" data-skill="per" title="Perception">
             <i class="fas fa-eye"></i> Per
           </button>
           <button type="button" data-action="requestSkill" data-skill="dec" title="Deception">
             Dec
           </button>
           <button type="button" data-action="requestSkill" data-skill="dip" title="Diplomacy">
             Dip
           </button>
           <button type="button" data-action="requestSkill" data-skill="itm" title="Intimidation">
             Itm
           </button>
           <button type="button" data-action="requestSkill" data-skill="prf" title="Performance">
             Prf
           </button>
           <button type="button" data-action="openSkillMenu" title="More skills...">
             <i class="fas fa-ellipsis-h"></i>
           </button>
         </div>

         <div class="dc-input">
           <label>DC:</label>
           <div class="dc-presets">
             <button type="button" data-action="setDC" data-dc="10">10</button>
             <button type="button" data-action="setDC" data-dc="15">15</button>
             <button type="button" data-action="setDC" data-dc="20" class="selected">20</button>
             <button type="button" data-action="setDC" data-dc="25">25</button>
             <button type="button" data-action="setDC" data-dc="30">30</button>
           </div>
           <input type="number" name="custom-dc" value="{{currentDC}}" min="1" max="60"
                  data-action="setCustomDC" placeholder="DC">
         </div>

         <!-- DC Visibility Control -->
         <div class="dc-visibility">
           <label>DC Visibility:</label>
           <div class="visibility-options">
             <label class="radio-option">
               <input type="radio" name="dc-visibility" value="gm"
                      {{#if (eq dcVisibility 'gm')}}checked{{/if}}
                      data-action="setDCVisibility">
               <span>Hidden (GM only)</span>
             </label>
             <label class="radio-option">
               <input type="radio" name="dc-visibility" value="all"
                      {{#if (eq dcVisibility 'all')}}checked{{/if}}
                      data-action="setDCVisibility">
               <span>Visible to players</span>
             </label>
           </div>
         </div>

         <div class="request-actions">
           <button type="button" data-action="requestSelectedCheck" class="request-btn">
             Request Check
           </button>
           <button type="button" data-action="requestAllCheck" class="request-all-btn" title="Request from all participants">
             <i class="fas fa-users"></i> All
           </button>
         </div>
       </div>
     </div>
   </div>
   ```

2. The panel should appear below the speakers sidebar (or as a separate column on wider layouts).
   For the three-column layout, consider placing it at the bottom of the speakers-sidebar div,
   or as a fourth column. Design decision: Place at bottom of speakers-sidebar for now.
  </action>
  <verify>
- Open GM interface in Foundry
- See Participants panel header below Speakers
- Click header to collapse/expand panel
- Empty state shows when no participants
- DC visibility radio buttons are present
  </verify>
  <done>Participants panel HTML structure in template with skill buttons, DC input, and DC visibility control</done>
</task>

<task type="auto">
  <name>Task 2: Add participant management logic to GMInterfaceApp</name>
  <files>scripts/applications/gm-interface.mjs</files>
  <action>
Add participant management methods and action handlers to GMInterfaceApp:

1. Add to DEFAULT_OPTIONS.actions:
   - toggleParticipantsPanel: GMInterfaceApp._onToggleParticipantsPanel
   - addAllPCs: GMInterfaceApp._onAddAllPCs
   - toggleParticipantSelection: GMInterfaceApp._onToggleParticipantSelection
   - removeParticipant: GMInterfaceApp._onRemoveParticipant
   - requestSkill: GMInterfaceApp._onRequestSkill
   - openSkillMenu: GMInterfaceApp._onOpenSkillMenu
   - setDC: GMInterfaceApp._onSetDC
   - setCustomDC: GMInterfaceApp._onSetCustomDC
   - setDCVisibility: GMInterfaceApp._onSetDCVisibility
   - requestSelectedCheck: GMInterfaceApp._onRequestSelectedCheck
   - requestAllCheck: GMInterfaceApp._onRequestAllCheck

2. Add instance properties in constructor:
   - this.participantsPanelCollapsed = false
   - this.selectedParticipants = new Set()
   - this.currentDC = 20
   - this.dcVisibility = 'gm'  // 'gm' (hidden) or 'all' (visible to players)

3. Update _prepareContext to include:
   - participantsPanelCollapsed: this.participantsPanelCollapsed
   - currentDC: this.currentDC
   - dcVisibility: this.dcVisibility
   - hasParticipants: state.participants?.length > 0
   - participants: resolved participant data with selection state

4. Add participant resolution in _prepareContext:
   ```javascript
   const participants = await Promise.all(
     (state.participants || []).map(async p => {
       const actor = await fromUuid(p.actorUuid);
       return {
         id: p.id,
         actorUuid: p.actorUuid,
         userId: p.userId,
         img: actor?.img || 'icons/svg/mystery-man.svg',
         name: actor?.name || 'Unknown',
         selected: this.selectedParticipants.has(p.id)
       };
     })
   );
   ```

5. Add _getPlayerCharacters() helper:
   ```javascript
   _getPlayerCharacters() {
     return game.actors.filter(actor => {
       if (actor.type !== 'character') return false;
       return game.users.some(user =>
         !user.isGM && actor.testUserPermission(user, 'OWNER')
       );
     });
   }
   ```

6. Implement action handlers:
   - _onToggleParticipantsPanel: toggle this.participantsPanelCollapsed, render()
   - _onAddAllPCs: get all PCs, add each via socket, show notification
   - _onToggleParticipantSelection: add/remove from selectedParticipants Set, render()
   - _onRemoveParticipant: call socketManager.requestRemoveParticipant(id)
   - _onSetDC: update this.currentDC from data-dc attribute, render()
   - _onSetCustomDC: update this.currentDC from input value
   - _onSetDCVisibility: update this.dcVisibility from radio value, render()
   - _onRequestSkill: call _requestSkillCheck with skill slug
   - _onRequestSelectedCheck: call _requestSkillCheck for selected participants
   - _onRequestAllCheck: call _requestSkillCheck for all participants

7. Add _requestSkillCheck(skillSlug, participantIds) method:
   ```javascript
   async _requestSkillCheck(skillSlug, participantIds) {
     if (!participantIds || participantIds.length === 0) {
       ui.notifications.warn('No participants selected');
       return;
     }

     const state = game.storyframe.stateManager.getState();

     for (const participantId of participantIds) {
       const participant = state.participants.find(p => p.id === participantId);
       if (!participant) continue;

       const requestId = foundry.utils.randomID();
       const request = {
         id: requestId,
         participantId,
         skillSlug,
         dc: {
           value: this.currentDC,
           visibility: this.dcVisibility  // Uses GM's current visibility setting
         },
         timestamp: Date.now()
       };

       // Add to pending rolls
       await game.storyframe.socketManager.requestAddPendingRoll(request);

       // Trigger on player's client
       await game.storyframe.socketManager.triggerSkillCheckOnPlayer(
         participant.userId,
         request
       );
     }

     const skillName = this._getSkillName(skillSlug);
     ui.notifications.info(`Requested ${skillName} check from ${participantIds.length} participant(s)`);
   }
   ```

8. Add _getSkillName(slug) helper that maps slugs to display names (per, dec, dip, etc.)

9. Add drag-drop handler for participant zone in _attachDragDropHandlers:
   - Accept Actor drops with type 'character'
   - Find owning user, warn if no player owner
   - Call socketManager.requestAddParticipant({actorUuid, userId})

Note: PF2e handles untrained skill rolls automatically - if an actor doesn't have a skill trained,
they can still roll at -2 (untrained). No validation needed on the GM side.
  </action>
  <verify>
- Open GM interface, see Participants panel
- Click "Add All PCs" - all player characters appear
- Click participant to select (highlight)
- Click Perception button - notification shows request sent
- Toggle DC visibility between "Hidden" and "Visible"
- Check state: `game.storyframe.stateManager.getState().pendingRolls` has entry with correct visibility
  </verify>
  <done>GMInterfaceApp has full participant management, skill request functionality, and DC visibility control</done>
</task>

<task type="auto">
  <name>Task 3: Style participants panel and skill request UI</name>
  <files>styles/gm-interface.css</files>
  <action>
Add CSS for the participants panel and skill check request interface:

1. Participants panel base:
   ```css
   .participants-panel {
     border-top: 1px solid var(--color-border-light, #ccc);
     margin-top: 0.5rem;
   }

   .participants-panel .panel-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     padding: 0.5rem;
     cursor: pointer;
     background: var(--color-bg-option, #f0f0f0);
   }

   .participants-panel .panel-header h3 {
     margin: 0;
     font-size: 0.9rem;
   }

   .participants-panel.collapsed .panel-content {
     display: none;
   }
   ```

2. Participant list:
   ```css
   .participant-list {
     display: flex;
     flex-direction: column;
     gap: 0.25rem;
     padding: 0.5rem;
     min-height: 60px;
     background: var(--color-bg-option, #fafafa);
   }

   .participant-item {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     padding: 0.25rem;
     border-radius: 4px;
     cursor: pointer;
     transition: background 0.15s;
   }

   .participant-item:hover {
     background: var(--color-bg-btn, #e0e0e0);
   }

   .participant-item.selected {
     background: var(--color-primary-light, #d4edda);
     border: 1px solid var(--color-primary, #28a745);
   }

   .participant-item img {
     width: 32px;
     height: 32px;
     border-radius: 4px;
     object-fit: cover;
   }

   .participant-item .remove-participant {
     margin-left: auto;
     opacity: 0;
     transition: opacity 0.15s;
   }

   .participant-item:hover .remove-participant {
     opacity: 1;
   }
   ```

3. Skill request section:
   ```css
   .skill-request-section {
     padding: 0.5rem;
     border-top: 1px solid var(--color-border-light, #ddd);
   }

   .quick-skills {
     display: flex;
     flex-wrap: wrap;
     gap: 0.25rem;
     margin-bottom: 0.5rem;
   }

   .quick-skills button {
     padding: 0.25rem 0.5rem;
     font-size: 0.8rem;
     border: 1px solid var(--color-border, #ccc);
     border-radius: 3px;
     background: var(--color-bg-btn, #f5f5f5);
     cursor: pointer;
   }

   .quick-skills button:hover {
     background: var(--color-bg-btn-hover, #e8e8e8);
   }
   ```

4. DC input:
   ```css
   .dc-input {
     display: flex;
     align-items: center;
     gap: 0.5rem;
     margin-bottom: 0.5rem;
   }

   .dc-input label {
     font-weight: bold;
     font-size: 0.85rem;
   }

   .dc-presets {
     display: flex;
     gap: 0.25rem;
   }

   .dc-presets button {
     width: 32px;
     height: 24px;
     padding: 0;
     font-size: 0.75rem;
     border: 1px solid var(--color-border, #ccc);
     border-radius: 3px;
     background: var(--color-bg-btn, #f5f5f5);
     cursor: pointer;
   }

   .dc-presets button.selected {
     background: var(--color-primary, #5e81ac);
     color: white;
     border-color: var(--color-primary, #5e81ac);
   }

   .dc-input input[type="number"] {
     width: 50px;
     text-align: center;
   }
   ```

5. DC visibility control:
   ```css
   .dc-visibility {
     margin-bottom: 0.5rem;
     padding: 0.25rem 0;
   }

   .dc-visibility label {
     font-weight: bold;
     font-size: 0.85rem;
     display: block;
     margin-bottom: 0.25rem;
   }

   .visibility-options {
     display: flex;
     gap: 1rem;
   }

   .visibility-options .radio-option {
     display: flex;
     align-items: center;
     gap: 0.25rem;
     cursor: pointer;
     font-size: 0.85rem;
   }

   .visibility-options input[type="radio"] {
     margin: 0;
   }
   ```

6. Request actions:
   ```css
   .request-actions {
     display: flex;
     gap: 0.5rem;
   }

   .request-actions .request-btn {
     flex: 1;
     padding: 0.5rem;
     background: var(--color-primary, #5e81ac);
     color: white;
     border: none;
     border-radius: 4px;
     cursor: pointer;
   }

   .request-actions .request-btn:hover {
     background: var(--color-primary-dark, #4c669f);
   }

   .request-actions .request-all-btn {
     padding: 0.5rem;
     background: var(--color-secondary, #6c757d);
     color: white;
     border: none;
     border-radius: 4px;
     cursor: pointer;
   }
   ```

7. Drag-drop feedback:
   ```css
   .participant-list.drag-over {
     background: var(--color-primary-light, #e3f2fd);
     border: 2px dashed var(--color-primary, #5e81ac);
   }
   ```
  </action>
  <verify>
- Open GM interface
- Participants panel is visually distinct from speakers
- Panel collapses/expands smoothly
- Selected participants have highlight
- Skill buttons and DC presets are clickable and styled
- DC visibility radio buttons are styled and functional
- Drag-drop zone shows feedback on dragover
  </verify>
  <done>Participants panel and skill request UI has complete, polished styling including DC visibility control</done>
</task>

</tasks>

<verification>
1. GM interface shows Participants panel below Speakers
2. "Add All PCs" button adds all player characters to panel
3. Clicking a participant toggles selection (visual highlight)
4. Clicking skill button with selected participant(s) creates pending roll
5. DC preset buttons update the DC value
6. Custom DC input works
7. DC visibility can be toggled between "Hidden" and "Visible"
8. "Request Check" and "All" buttons send requests with correct visibility
9. Remove button removes participant from panel
10. Panel collapse/expand works
</verification>

<success_criteria>
- GM can see and interact with Participants panel
- GM can add PCs via drag-drop or "Add All PCs"
- GM can select participants and request skill checks
- DC can be set via presets or custom input
- DC visibility can be controlled per-request (hidden or visible to players)
- Requests create pending rolls in state with correct visibility setting
- UI is styled and responsive
</success_criteria>

<output>
After completion, create `.planning/phases/06-pc-participants-pf2e-checks/06-02-SUMMARY.md`
</output>
